---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import SidePanel from '../../components/SidePanel.astro';
import StorehausPromo from '../../components/StorehausPromo.astro';
---
<BaseLayout
  title="Halo Wars 2 Stats - Team Respawn"
  description="Search for any gamertag and view Halo Wars 2 player stats, ranked CSR, leader usage, and recent match history."
  keywords="Halo Wars 2 stats, HW2 stats, Halo Wars 2 ranked, CSR lookup, gamertag search, Halo Wars 2 leaderboard"
  canonical="https://www.teamrespawn.net/halo-wars-stats/"
  ogTitle="Halo Wars 2 Stats Lookup - Team Respawn"
  ogDescription="Search any gamertag to view Halo Wars 2 player stats, ranked CSR, leader usage, and match history."
  ogImage="https://www.teamrespawn.net/content/Team-Respawn-Full.png"
>
  <Fragment slot="head">
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "WebPage",
        "name": "Halo Wars 2 Stats Lookup",
        "description": "Search for any gamertag and view Halo Wars 2 player stats, ranked CSR, leader usage, and recent match history.",
        "url": "https://www.teamrespawn.net/halo-wars-stats/",
        "isPartOf": {
          "@type": "WebSite",
          "name": "Team Respawn",
          "url": "https://www.teamrespawn.net"
        }
      }
    </script>
    <style>
      @keyframes scanline {
        0% { transform: translateY(-100%); }
        100% { transform: translateY(100%); }
      }
      .scan-line::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(90deg, transparent, rgba(6, 182, 212, 0.15), transparent);
        animation: scanline 4s linear infinite;
        pointer-events: none;
      }
      @keyframes csr-glow {
        0%, 100% { box-shadow: 0 0 15px rgba(6, 182, 212, 0.3); }
        50% { box-shadow: 0 0 30px rgba(6, 182, 212, 0.5); }
      }
      .csr-glow { animation: csr-glow 3s ease-in-out infinite; }

      body.match-share-open {
        overflow: hidden;
      }

      .match-share-modal {
        position: fixed;
        inset: 0;
        z-index: 70;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 24px;
      }

      .match-share-modal.hidden {
        display: none;
      }

      .match-share-backdrop {
        position: absolute;
        inset: 0;
        background: rgba(2, 6, 23, 0.75);
        backdrop-filter: blur(2px);
      }

      .match-share-panel {
        position: relative;
        z-index: 1;
        width: min(900px, 95vw);
        background: rgba(15, 23, 42, 0.96);
        border: 1px solid rgba(148, 163, 184, 0.2);
        border-radius: 14px;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.45);
        padding: 18px 20px 22px;
        color: #e2e8f0;
      }

      .match-share-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 12px;
      }

      .match-share-title {
        font-size: 1rem;
        font-weight: 700;
        color: #f8fafc;
      }

      .match-share-close {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 34px;
        height: 34px;
        border-radius: 8px;
        background: rgba(148, 163, 184, 0.12);
        border: 1px solid rgba(148, 163, 184, 0.2);
        color: #cbd5f5;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .match-share-close:hover {
        background: rgba(148, 163, 184, 0.2);
        color: #f8fafc;
      }

      .match-share-content {
        display: flex;
        flex-direction: column;
        gap: 14px;
      }

      .match-share-card {
        width: min(640px, 100%);
        border-radius: 14px;
        border: 1px solid rgba(148, 163, 184, 0.2);
        background: linear-gradient(135deg, rgba(10, 22, 40, 0.95), rgba(11, 42, 66, 0.95));
        padding: 16px;
        color: #f8fafc;
        box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.05);
      }

      .match-share-card-top {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 12px;
      }

      .match-share-result {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 4px 10px;
        min-height: 20px;
        min-width: 72px;
        border-radius: 999px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-size: 10px;
        font-weight: 700;
        border: 1px solid transparent;
        line-height: 1;
        text-align: center;
      }

      .match-share-result.win {
        color: #22c55e;
        background: rgba(34, 197, 94, 0.15);
        border-color: rgba(34, 197, 94, 0.35);
      }

      .match-share-result.loss {
        color: #f87171;
        background: rgba(248, 113, 113, 0.15);
        border-color: rgba(248, 113, 113, 0.35);
      }

      .match-share-result.draw {
        color: #94a3b8;
        background: rgba(148, 163, 184, 0.2);
        border-color: rgba(148, 163, 184, 0.3);
      }

      .match-share-gamertag {
        font-size: 1.3rem;
        font-weight: 700;
        margin-top: 6px;
      }

      .match-share-subtitle {
        font-size: 0.8rem;
        color: rgba(148, 163, 184, 0.9);
      }

      .match-share-logo {
        width: 120px;
        height: auto;
        opacity: 0.9;
      }

      .match-share-hero {
        margin-top: 12px;
        height: 150px;
        border-radius: 12px;
        background: linear-gradient(120deg, rgba(2, 6, 23, 0.85), rgba(6, 40, 64, 0.85));
        background-size: cover;
        background-position: center;
        position: relative;
        overflow: hidden;
        border: 1px solid rgba(148, 163, 184, 0.15);
      }

      .match-share-hero-overlay {
        position: absolute;
        inset: 0;
        padding: 12px;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        gap: 4px;
        background: linear-gradient(180deg, rgba(2, 6, 23, 0.1) 0%, rgba(2, 6, 23, 0.85) 100%);
      }

      .match-share-map {
        font-size: 1.05rem;
        font-weight: 600;
      }

      .match-share-leader {
        font-size: 0.75rem;
        color: rgba(226, 232, 240, 0.7);
      }

      .match-share-stats {
        margin-top: 12px;
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 8px;
      }

      .match-share-stat {
        background: rgba(15, 23, 42, 0.65);
        border: 1px solid rgba(148, 163, 184, 0.15);
        border-radius: 10px;
        padding: 8px;
      }

      .match-share-stat span {
        display: block;
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: rgba(148, 163, 184, 0.9);
      }

      .match-share-stat strong {
        display: block;
        font-size: 14px;
        color: #f8fafc;
        margin-top: 4px;
      }

      .match-share-footer {
        margin-top: 10px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        font-size: 11px;
        color: rgba(148, 163, 184, 0.9);
      }

      .match-share-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .match-share-actions button {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 12px;
        border-radius: 8px;
        background: rgba(148, 163, 184, 0.12);
        border: 1px solid rgba(148, 163, 184, 0.2);
        color: #e2e8f0;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .match-share-actions button:hover {
        background: rgba(148, 163, 184, 0.2);
        color: #f8fafc;
        transform: translateY(-1px);
      }

      .match-share-links {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .match-share-link {
        width: 36px;
        height: 36px;
        border-radius: 10px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: rgba(148, 163, 184, 0.12);
        border: 1px solid rgba(148, 163, 184, 0.2);
        color: #94a3b8;
        transition: all 0.2s ease;
        text-decoration: none;
      }

      .match-share-link:hover {
        background: rgba(148, 163, 184, 0.2);
        color: var(--hover-color, #f8fafc);
        transform: translateY(-1px);
      }

      .match-share-link[data-color="#1877F2"]:hover {
        color: #1877F2;
      }

      .match-share-link[data-color="#0A66C2"]:hover {
        color: #0A66C2;
      }

      .match-share-link[data-color="#FF4500"]:hover {
        color: #FF4500;
      }

      .match-share-link[data-color="#000000"]:hover {
        color: #000000;
      }

      .match-share-link svg {
        width: 16px;
        height: 16px;
      }

      .match-share-status {
        min-height: 16px;
        font-size: 12px;
        color: rgba(148, 163, 184, 0.9);
      }

      .match-share-status.ok {
        color: #22c55e;
      }

      .match-share-status.error {
        color: #f87171;
      }

      @keyframes share-skeleton {
        0% { background-position: -200px 0; }
        100% { background-position: calc(200px + 100%) 0; }
      }

      .share-skeleton {
        position: relative;
        display: inline-block;
        min-width: var(--skeleton-width, 80px);
        min-height: 1em;
      }

      .match-share-card.share-loading .share-skeleton {
        color: transparent !important;
      }

      .match-share-gamertag.share-skeleton {
        display: block;
      }

      .match-share-card.share-loading .share-skeleton::after {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: 6px;
        background: linear-gradient(90deg, rgba(148, 163, 184, 0.12), rgba(148, 163, 184, 0.28), rgba(148, 163, 184, 0.12));
        background-size: 200px 100%;
        animation: share-skeleton 1.2s ease-in-out infinite;
      }

      @media (max-width: 640px) {
        .match-share-panel {
          padding: 16px;
        }

        .match-share-card {
          padding: 14px;
        }

        .match-share-stats {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .match-share-logo {
          width: 90px;
        }
      }
    </style>
  </Fragment>

  <a
    href="#main-content"
    class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-50 focus:bg-white focus:text-black focus:px-4 focus:py-2 focus:rounded"
  >
    Skip to main content
  </a>

  <div class="container mx-auto p-4 sm:p-8">
    <Header />

    <main id="main-content" role="main" aria-label="Halo Wars 2 Stats">
      <!-- Hero Banner -->
      <section class="relative mb-8 rounded-xl overflow-hidden border border-cyan-500/20 scan-line" style="background: linear-gradient(135deg, #0a1628 0%, #0c2942 40%, #0a1628 100%);">
        <div class="relative z-10 px-6 py-10 sm:py-14 text-center">
          <h1 class="text-3xl sm:text-5xl font-bold mb-3 text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 via-cyan-400 to-teal-300">
            Halo Wars 2 Stats
          </h1>
          <p class="text-cyan-200/70 text-base sm:text-lg max-w-2xl mx-auto">
            Search for a gamertag to view player stats, ranked CSR, leader usage, and recent match history.
          </p>
        </div>
      </section>

      <!-- Search Bar -->
      <section class="mb-8">
        <div class="flex flex-col sm:flex-row gap-3 max-w-2xl mx-auto">
          <div class="relative flex-1">
            <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-cyan-400/60" aria-hidden="true"></i>
            <input
              id="gamertag-input"
              type="text"
              placeholder="Enter gamertag..."
              autocomplete="off"
              class="w-full pl-11 pr-4 py-3 rounded-lg bg-slate-800/60 border border-cyan-500/30 text-white placeholder-gray-400 focus:outline-none focus:border-cyan-400 focus:ring-1 focus:ring-cyan-400/50 font-mono text-base transition-colors duration-200"
              aria-label="Gamertag search"
            />
          </div>
          <button
            id="search-btn"
            type="button"
            class="px-6 py-3 rounded-lg bg-cyan-600 hover:bg-cyan-700 text-white font-semibold transition-colors duration-200 flex items-center justify-center gap-2 whitespace-nowrap"
          >
            <i class="fas fa-search" aria-hidden="true"></i>
            Search
          </button>
        </div>
        <!-- Recent Searches -->
        <div id="recent-searches" class="max-w-2xl mx-auto mt-3 flex flex-wrap gap-2 hidden"></div>
      </section>

      <!-- Results Container -->
      <div id="results-container" class="hidden space-y-6">
        <!-- Player Overview Card -->
        <section id="player-overview" class="rounded-xl p-6 backdrop-blur-sm border border-cyan-500/20" style="background: rgba(30, 41, 59, 0.4);">
          <div id="overview-skeleton" class="space-y-4">
            <div class="h-8 w-64 bg-slate-700/50 rounded animate-pulse"></div>
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
              <div class="h-16 bg-slate-700/50 rounded animate-pulse"></div>
              <div class="h-16 bg-slate-700/50 rounded animate-pulse"></div>
              <div class="h-16 bg-slate-700/50 rounded animate-pulse"></div>
              <div class="h-16 bg-slate-700/50 rounded animate-pulse"></div>
              <div class="h-16 bg-slate-700/50 rounded animate-pulse"></div>
              <div class="h-16 bg-slate-700/50 rounded animate-pulse"></div>
              <div class="h-16 bg-slate-700/50 rounded animate-pulse"></div>
              <div class="h-16 bg-slate-700/50 rounded animate-pulse"></div>
            </div>
          </div>
          <div id="overview-content" class="hidden">
            <h2 id="player-gamertag" class="text-2xl sm:text-3xl font-bold text-cyan-300 mb-4 font-mono"></h2>
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
              <div class="bg-slate-800/40 rounded-lg p-4 border border-cyan-500/10">
                <p class="text-xs text-gray-400 uppercase tracking-wider mb-1">Matches</p>
                <p id="stat-matches" class="text-xl font-bold font-mono text-white">-</p>
              </div>
              <div class="bg-slate-800/40 rounded-lg p-4 border border-cyan-500/10">
                <p class="text-xs text-gray-400 uppercase tracking-wider mb-1">Wins</p>
                <p id="stat-wins" class="text-xl font-bold font-mono text-green-400">-</p>
              </div>
              <div class="bg-slate-800/40 rounded-lg p-4 border border-cyan-500/10">
                <p class="text-xs text-gray-400 uppercase tracking-wider mb-1">Losses</p>
                <p id="stat-losses" class="text-xl font-bold font-mono text-red-400">-</p>
              </div>
              <div class="bg-slate-800/40 rounded-lg p-4 border border-cyan-500/10">
                <p class="text-xs text-gray-400 uppercase tracking-wider mb-1">Win Rate</p>
                <p id="stat-winrate" class="text-xl font-bold font-mono text-cyan-300">-</p>
              </div>
              <div class="bg-slate-800/40 rounded-lg p-4 border border-cyan-500/10">
                <p class="text-xs text-gray-400 uppercase tracking-wider mb-1">TR Viewer Rating</p>
                <p id="stat-winrate-label" class="text-xl font-bold font-mono text-white">-</p>
              </div>
              <div class="bg-slate-800/40 rounded-lg p-4 border border-cyan-500/10">
                <p class="text-xs text-gray-400 uppercase tracking-wider mb-1">Time Played (MM)</p>
                <p id="stat-time" class="text-xl font-bold font-mono text-white">-</p>
                <p id="stat-time-all" class="text-xs text-gray-400 mt-1">All modes: -</p>
              </div>
              <div class="bg-slate-800/40 rounded-lg p-4 border border-cyan-500/10">
                <p class="text-xs text-gray-400 uppercase tracking-wider mb-1">Avg Match (MM)</p>
                <p id="stat-avg-match" class="text-xl font-bold font-mono text-white">-</p>
              </div>
              <div class="bg-slate-800/40 rounded-lg p-4 border border-cyan-500/10">
                <p class="text-xs text-gray-400 uppercase tracking-wider mb-1">Terminus Wave (All Modes)</p>
                <p id="stat-terminus-wave" class="text-xl font-bold font-mono text-white">-</p>
              </div>
            </div>
          </div>
          <div id="overview-error" class="hidden"></div>
        </section>

        <!-- Ranked Stats Grid -->
        <section id="ranked-stats">
          <h2 class="text-xl font-bold text-cyan-300 mb-4">
            <i class="fas fa-trophy text-cyan-400 mr-2" aria-hidden="true"></i>Ranked Stats
          </h2>
          <div id="ranked-skeleton" class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="rounded-xl p-6 border border-cyan-500/20 h-52 animate-pulse" style="background: rgba(30, 41, 59, 0.4);"><div class="h-4 w-24 bg-slate-700/50 rounded mb-2"></div><div class="h-3 w-20 bg-slate-700/50 rounded mb-4"></div><div class="h-20 w-20 bg-slate-700/50 rounded-full mx-auto mb-3"></div><div class="h-4 w-32 bg-slate-700/50 rounded mx-auto"></div></div>
            <div class="rounded-xl p-6 border border-cyan-500/20 h-52 animate-pulse" style="background: rgba(30, 41, 59, 0.4);"><div class="h-4 w-24 bg-slate-700/50 rounded mb-2"></div><div class="h-3 w-20 bg-slate-700/50 rounded mb-4"></div><div class="h-20 w-20 bg-slate-700/50 rounded-full mx-auto mb-3"></div><div class="h-4 w-32 bg-slate-700/50 rounded mx-auto"></div></div>
            <div class="rounded-xl p-6 border border-cyan-500/20 h-52 animate-pulse" style="background: rgba(30, 41, 59, 0.4);"><div class="h-4 w-24 bg-slate-700/50 rounded mb-2"></div><div class="h-3 w-20 bg-slate-700/50 rounded mb-4"></div><div class="h-20 w-20 bg-slate-700/50 rounded-full mx-auto mb-3"></div><div class="h-4 w-32 bg-slate-700/50 rounded mx-auto"></div></div>
            <div class="rounded-xl p-6 border border-cyan-500/20 h-52 animate-pulse" style="background: rgba(30, 41, 59, 0.4);"><div class="h-4 w-24 bg-slate-700/50 rounded mb-2"></div><div class="h-3 w-20 bg-slate-700/50 rounded mb-4"></div><div class="h-20 w-20 bg-slate-700/50 rounded-full mx-auto mb-3"></div><div class="h-4 w-32 bg-slate-700/50 rounded mx-auto"></div></div>
            <div class="rounded-xl p-6 border border-cyan-500/20 h-52 animate-pulse" style="background: rgba(30, 41, 59, 0.4);"><div class="h-4 w-24 bg-slate-700/50 rounded mb-2"></div><div class="h-3 w-20 bg-slate-700/50 rounded mb-4"></div><div class="h-20 w-20 bg-slate-700/50 rounded-full mx-auto mb-3"></div><div class="h-4 w-32 bg-slate-700/50 rounded mx-auto"></div></div>
            <div class="rounded-xl p-6 border border-cyan-500/20 h-52 animate-pulse" style="background: rgba(30, 41, 59, 0.4);"><div class="h-4 w-24 bg-slate-700/50 rounded mb-2"></div><div class="h-3 w-20 bg-slate-700/50 rounded mb-4"></div><div class="h-20 w-20 bg-slate-700/50 rounded-full mx-auto mb-3"></div><div class="h-4 w-32 bg-slate-700/50 rounded mx-auto"></div></div>
          </div>
          <div id="ranked-content" class="hidden grid grid-cols-1 md:grid-cols-3 gap-4"></div>
          <div id="ranked-error" class="hidden"></div>
        </section>

        <!-- Leader Usage -->
          <section id="leader-usage">
            <h2 class="text-xl font-bold text-cyan-300 mb-4">
              <button
                id="leaders-toggle"
                type="button"
                class="w-full flex items-center justify-between text-left"
                aria-expanded="true"
                aria-controls="leaders-panel"
              >
                <span class="flex items-center">
                  <i class="fas fa-users text-cyan-400 mr-2" aria-hidden="true"></i>
                  Leader Usage
                </span>
                <span class="flex items-center gap-1 text-xs text-cyan-300/80">
                  <span>Collapse</span>
                  <span class="leaders-chevron transition-transform duration-200" aria-hidden="true">&#x25BC;</span>
                </span>
              </button>
            </h2>
            <div id="leaders-panel">
              <div id="leaders-skeleton" class="rounded-xl p-6 border border-cyan-500/20 space-y-3" style="background: rgba(30, 41, 59, 0.4);">
              <div class="h-8 bg-slate-700/50 rounded animate-pulse"></div>
              <div class="h-8 bg-slate-700/50 rounded animate-pulse w-5/6"></div>
              <div class="h-8 bg-slate-700/50 rounded animate-pulse w-4/6"></div>
              <div class="h-8 bg-slate-700/50 rounded animate-pulse w-3/6"></div>
              </div>
              <div id="leaders-content" class="hidden rounded-xl p-6 border border-cyan-500/20" style="background: rgba(30, 41, 59, 0.4);"></div>
              <div id="leaders-error" class="hidden"></div>
            </div>
          </section>

        <!-- Recent Matches -->
        <section id="recent-matches">
          <h2 class="text-xl font-bold text-cyan-300 mb-4">
            <i class="fas fa-history text-cyan-400 mr-2" aria-hidden="true"></i>Recent Matches
          </h2>
          <div id="matches-skeleton" class="rounded-xl border border-cyan-500/20 overflow-hidden" style="background: rgba(30, 41, 59, 0.4);">
            <div class="space-y-0">
              <div class="p-4 border-b border-slate-700/30 animate-pulse"><div class="flex gap-4 items-center"><div class="h-12 w-20 bg-slate-700/50 rounded"></div><div class="flex-1 space-y-2"><div class="h-4 bg-slate-700/50 rounded w-1/3"></div><div class="h-3 bg-slate-700/50 rounded w-1/4"></div></div></div></div>
              <div class="p-4 border-b border-slate-700/30 animate-pulse"><div class="flex gap-4 items-center"><div class="h-12 w-20 bg-slate-700/50 rounded"></div><div class="flex-1 space-y-2"><div class="h-4 bg-slate-700/50 rounded w-1/3"></div><div class="h-3 bg-slate-700/50 rounded w-1/4"></div></div></div></div>
              <div class="p-4 border-b border-slate-700/30 animate-pulse"><div class="flex gap-4 items-center"><div class="h-12 w-20 bg-slate-700/50 rounded"></div><div class="flex-1 space-y-2"><div class="h-4 bg-slate-700/50 rounded w-1/3"></div><div class="h-3 bg-slate-700/50 rounded w-1/4"></div></div></div></div>
            </div>
          </div>
          <div id="matches-content" class="hidden rounded-xl border border-cyan-500/20 overflow-hidden" style="background: rgba(30, 41, 59, 0.4);"></div>
          <div id="matches-error" class="hidden"></div>
        </section>
      </div>

      <!-- Match Share Modal -->
      <div id="match-share-modal" class="match-share-modal hidden" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="match-share-title">
        <div class="match-share-backdrop" data-close="true"></div>
        <div class="match-share-panel" role="document">
          <div class="match-share-header">
            <h3 id="match-share-title" class="match-share-title">Share Match</h3>
            <button type="button" class="match-share-close" data-close="true" aria-label="Close share dialog">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
          <div class="match-share-content">
            <div id="match-share-card" class="match-share-card" aria-label="Match share card preview">
              <div class="match-share-card-top">
                <div>
                  <span id="match-share-result" class="match-share-result draw share-skeleton" style="--skeleton-width: 64px;">Draw</span>
                  <div id="match-share-gamertag" class="match-share-gamertag share-skeleton" style="--skeleton-width: 140px;">Gamertag</div>
                  <div id="match-share-subtitle" class="match-share-subtitle share-skeleton" style="--skeleton-width: 160px;">Match summary</div>
                </div>
                <img id="match-share-logo" class="match-share-logo" src="/content/Team-Respawn-Full.png" alt="Team Respawn" loading="eager" />
              </div>
              <div id="match-share-hero" class="match-share-hero">
                <div class="match-share-hero-overlay">
                  <div id="match-share-map" class="match-share-map share-skeleton" style="--skeleton-width: 120px;">Unknown Map</div>
                  <div id="match-share-leader" class="match-share-leader share-skeleton" style="--skeleton-width: 110px;">Unknown Leader</div>
                </div>
              </div>
              <div class="match-share-stats">
                <div class="match-share-stat">
                  <span>Duration</span>
                  <strong id="match-share-duration" class="share-skeleton" style="--skeleton-width: 48px;">-</strong>
                </div>
                <div class="match-share-stat">
                  <span>Leader Powers Used</span>
                  <strong id="match-share-powers" class="share-skeleton" style="--skeleton-width: 48px;">-</strong>
                </div>
                <div class="match-share-stat">
                  <span>Units Destroyed</span>
                  <strong id="match-share-units" class="share-skeleton" style="--skeleton-width: 48px;">-</strong>
                </div>
                <div class="match-share-stat">
                  <span>Team Size</span>
                  <strong id="match-share-team" class="share-skeleton" style="--skeleton-width: 48px;">-</strong>
                </div>
              </div>
              <div class="match-share-footer">
                <span id="match-share-playlist" class="share-skeleton" style="--skeleton-width: 90px;">Matchmaking</span>
                <span id="match-share-date" class="share-skeleton" style="--skeleton-width: 80px;"></span>
              </div>
            </div>

            <div class="match-share-actions">
              <button type="button" id="match-share-copy-link">Copy Link</button>
              <button type="button" id="match-share-download">Download Image</button>
              <button type="button" id="match-share-copy-image">Copy Image</button>
            </div>

            <div class="match-share-links" id="match-share-links">
              <a class="match-share-link" data-share="x" data-color="#000000" href="#" target="_blank" rel="noopener noreferrer" aria-label="Share on X" title="Share on X">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10.053,7.988l5.631,8.024h-1.497L8.566,7.988H10.053z M21,6v12 c0,1.657-1.343,3-3,3H6c-1.657,0-3-1.343-3-3V6c0-1.657,1.343-3,3-3h12C19.657,3,21,4.343,21,6z M17.538,17l-4.186-5.99L16.774,7 h-1.311l-2.704,3.16L10.552,7H6.702l3.941,5.633L6.906,17h1.333l3.001-3.516L13.698,17H17.538z" fill="currentColor"/></svg>
              </a>
              <a class="match-share-link" data-share="facebook" data-color="#1877F2" href="#" target="_blank" rel="noopener noreferrer" aria-label="Share on Facebook" title="Share on Facebook">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19,3H5C3.895,3,3,3.895,3,5v14c0,1.105,0.895,2,2,2h7.621v-6.961h-2.343v-2.725h2.343V9.309 c0-2.324,1.421-3.591,3.495-3.591c0.699-0.002,1.397,0.034,2.092,0.105v2.43h-1.428c-1.13,0-1.35,0.534-1.35,1.322v1.735h2.7 l-0.351,2.725h-2.365V21H19c1.105,0,2-0.895,2-2V5C21,3.895,20.105,3,19,3z" fill="currentColor"/></svg>
              </a>
              <a class="match-share-link" data-share="linkedin" data-color="#0A66C2" href="#" target="_blank" rel="noopener noreferrer" aria-label="Share on LinkedIn" title="Share on LinkedIn">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19,3H5C3.895,3,3,3.895,3,5v14c0,1.105,0.895,2,2,2h14c1.105,0,2-0.895,2-2V5C21,3.895,20.105,3,19,3z M9,17H6.477v-7H9 V17z M7.694,8.717c-0.771,0-1.286-0.514-1.286-1.2s0.514-1.2,1.371-1.2c0.771,0,1.286,0.514,1.286,1.2S8.551,8.717,7.694,8.717z M18,17h-2.442v-3.826c0-1.058-0.651-1.302-0.895-1.302s-1.058,0.163-1.058,1.302c0,0.163,0,3.826,0,3.826h-2.523v-7h2.523v0.977 C13.93,10.407,14.581,10,15.802,10C17.023,10,18,10.977,18,13.174V17z" fill="currentColor"/></svg>
              </a>
              <a class="match-share-link" data-share="reddit" data-color="#FF4500" href="#" target="_blank" rel="noopener noreferrer" aria-label="Share on Reddit" title="Share on Reddit">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 14 3 C 12.300781 3 11 4.414063 11 6 L 11 8.03125 C 8.882813 8.175781 6.976563 8.785156 5.4375 9.71875 C 4.878906 9.28125 4.21875 9.03125 3.5625 9.03125 C 2.835938 9.03125 2.128906 9.308594 1.625 9.875 C 0.667969 11.070313 0.753906 13.023438 2.09375 14.03125 C 2.03125 14.347656 2 14.667969 2 15 C 2 17.054688 3.242188 18.84375 5.0625 20.0625 C 6.882813 21.28125 9.320313 22 12 22 C 14.679688 22 17.117188 21.28125 18.9375 20.0625 C 20.757813 18.84375 22 17.054688 22 15 C 22 14.667969 21.9375 14.347656 21.875 14.03125 C 23.238281 12.945313 23.378906 11.003906 22.375 9.875 C 21.871094 9.308594 21.164063 9.03125 20.4375 9.03125 C 19.78125 9.03125 19.121094 9.28125 18.5625 9.71875 C 17.023438 8.785156 15.117188 8.175781 13 8.03125 L 13 6 C 13 5.386719 13.300781 5 14 5 C 14.320313 5 14.773438 5.171875 15.53125 5.4375 C 16.203125 5.671875 17.09375 5.914063 18.25 5.96875 C 18.589844 6.585938 19.25 7 20 7 C 21.101563 7 22 6.101563 22 5 C 22 3.898438 21.101563 3 20 3 C 19.273438 3 18.632813 3.382813 18.28125 3.96875 C 17.394531 3.925781 16.769531 3.765625 16.1875 3.5625 C 15.519531 3.328125 14.878906 3 14 3 Z M 20 4 C 20.601563 4 21 4.398438 21 5 C 21 5.601563 20.601563 6 20 6 C 19.398438 6 19 5.601563 19 5 C 19 4.398438 19.398438 4 20 4 Z M 12 10 C 14.320313 10 16.382813 10.636719 17.8125 11.59375 C 19.242188 12.550781 20 13.753906 20 15 C 20 16.246094 19.242188 17.449219 17.8125 18.40625 C 16.382813 19.363281 14.320313 20 12 20 C 9.679688 20 7.617188 19.363281 6.1875 18.40625 C 4.757813 17.449219 4 16.246094 4 15 C 4 13.753906 4.757813 12.550781 6.1875 11.59375 C 7.617188 10.636719 9.679688 10 12 10 Z M 3.59375 10.03125 C 3.925781 10.03125 4.277344 10.101563 4.59375 10.28125 C 3.628906 11.023438 2.878906 11.9375 2.4375 12.96875 C 1.855469 12.28125 1.867188 11.191406 2.375 10.53125 C 2.671875 10.195313 3.121094 10.03125 3.59375 10.03125 Z M 20.40625 10.03125 C 20.878906 10.03125 21.328125 10.195313 21.625 10.53125 C 22.117188 11.085938 22.15625 12.175781 21.5625 12.9375 C 21.121094 11.914063 20.363281 11.019531 19.40625 10.28125 C 19.722656 10.101563 20.074219 10.03125 20.40625 10.03125 Z M 9 12 C 8.171875 12 7.5 12.671875 7.5 13.5 C 7.5 14.328125 8.171875 15 9 15 C 9.828125 15 10.5 14.328125 10.5 13.5 C 10.5 12.671875 9.828125 12 9 12 Z M 15 12 C 14.171875 12 13.5 12.671875 13.5 13.5 C 13.5 14.328125 14.171875 15 15 15 C 15.828125 15 16.5 14.328125 16.5 13.5 C 16.5 12.671875 15.828125 12 15 12 Z M 16.09375 16.40625 C 15.195313 17.207031 13.699219 17.6875 12 17.6875 C 10.300781 17.6875 8.804688 17.199219 7.90625 16.5 C 8.40625 17.800781 10 19 12 19 C 14 19 15.59375 17.804688 16.09375 16.40625 Z" fill="currentColor"/></svg>
              </a>
            </div>

            <p id="match-share-status" class="match-share-status" role="status" aria-live="polite"></p>
          </div>
        </div>
      </div>

      <!-- Global Error Area -->
      <div id="global-error" class="hidden max-w-2xl mx-auto"></div>

      <!-- Storehaus Promo -->
      <StorehausPromo class="mt-10" />
    </main>

    <Footer />
  </div>

  <SidePanel />

  <script src="/js/side-panel.js" is:inline></script>
  <script src="/js/dropdowns.js" is:inline></script>

  <script>
    import { getPlayerStats, getPlayerSeasonStats, getPlayerMatches, getMatchResult, getMatchEvents, getLeaderPowerMap, getGameObjectMap, getTechMap } from '../../utils/haloApi';
    import { getCsrTier } from '../../data/haloWars2/csr';
    import { getLeaderName } from '../../data/haloWars2/leaders';
    import { getMapName, getMapImage, getMapImageFallback } from '../../data/haloWars2/maps';
    import { getPlaylistName } from '../../data/haloWars2/playlists';
    import { seasonData, getSeasonName } from '../../data/haloWars2/seasons';
    import { PLAYLIST_1V1_RANKED, PLAYLIST_2V2_RANKED, PLAYLIST_3V3_RANKED } from '../../data/haloWars2/playlistMappings';

    const searchInput = document.getElementById('gamertag-input') as HTMLInputElement;
    const searchBtn = document.getElementById('search-btn') as HTMLButtonElement;
    const resultsContainer = document.getElementById('results-container')!;
    const globalError = document.getElementById('global-error')!;
    const recentSearchesEl = document.getElementById('recent-searches')!;
    const shareModal = document.getElementById('match-share-modal') as HTMLElement | null;
    const shareCard = document.getElementById('match-share-card') as HTMLElement | null;
    const shareResultEl = document.getElementById('match-share-result') as HTMLElement | null;
    const shareGamertagEl = document.getElementById('match-share-gamertag') as HTMLElement | null;
    const shareSubtitleEl = document.getElementById('match-share-subtitle') as HTMLElement | null;
    const shareMapEl = document.getElementById('match-share-map') as HTMLElement | null;
    const shareLeaderEl = document.getElementById('match-share-leader') as HTMLElement | null;
    const shareDurationEl = document.getElementById('match-share-duration') as HTMLElement | null;
    const sharePowersEl = document.getElementById('match-share-powers') as HTMLElement | null;
    const shareUnitsEl = document.getElementById('match-share-units') as HTMLElement | null;
    const shareTeamEl = document.getElementById('match-share-team') as HTMLElement | null;
    const sharePlaylistEl = document.getElementById('match-share-playlist') as HTMLElement | null;
    const shareDateEl = document.getElementById('match-share-date') as HTMLElement | null;
    const shareHeroEl = document.getElementById('match-share-hero') as HTMLElement | null;
    const shareStatusEl = document.getElementById('match-share-status') as HTMLElement | null;
    const shareCopyLinkBtn = document.getElementById('match-share-copy-link') as HTMLButtonElement | null;
    const shareDownloadBtn = document.getElementById('match-share-download') as HTMLButtonElement | null;
    const shareCopyImageBtn = document.getElementById('match-share-copy-image') as HTMLButtonElement | null;
    const shareLinks = document.querySelectorAll('.match-share-link');
    const leadersToggle = document.getElementById('leaders-toggle') as HTMLButtonElement | null;
    const leadersPanel = document.getElementById('leaders-panel') as HTMLElement | null;
    const leadersChevron = leadersToggle?.querySelector('.leaders-chevron') as HTMLElement | null;
    const defaultSearchPlaceholder = 'Enter gamertag...';
    const rotatingGamertags = ['xandy92', 'btc hosticide', 'American SKLz', 'Slashstorm', 'Jolly Sine', 'Powermoes114', 'TheCommander158', 'Nakamura RTS', 'KGB Officer', 'Blackandfan', 'TR AndrUwU', 'PatrossDev', 'TiberiusCN', 'Frcnzied', 'nvxHa', 'Gandalf The Fat', 'OwO senpai4668'];
    const SHARE_HERO_GRADIENT = 'linear-gradient(120deg, rgba(2, 6, 23, 0.85), rgba(6, 40, 64, 0.85))';

    if (leadersToggle && leadersPanel) {
      const isExpanded = leadersToggle.getAttribute('aria-expanded') === 'true';
      if (leadersChevron) leadersChevron.style.transform = isExpanded ? 'rotate(180deg)' : 'rotate(0deg)';

      leadersToggle.addEventListener('click', () => {
        const expandedNow = leadersToggle.getAttribute('aria-expanded') === 'true';
        leadersToggle.setAttribute('aria-expanded', expandedNow ? 'false' : 'true');
        leadersPanel.classList.toggle('hidden', expandedNow);
        if (leadersChevron) leadersChevron.style.transform = expandedNow ? 'rotate(0deg)' : 'rotate(180deg)';
      });
    }

    let placeholderTimeoutId: number | null = null;
    let placeholderRunId = 0;
    let placeholderTarget = '';
    let placeholderRendered = '';
    let isDeletingPlaceholder = false;
    let scriptedPlaceholderIndex = 0;
    const scriptedPlaceholderGamertags = ['xandy92', 'American Sklz', 'btc hosticide'];
    let lastPlaceholderGamertag = '';
    const isSearchInputIdle = () => searchInput.value.trim() === '' && document.activeElement !== searchInput;

    function stopSearchPlaceholderRotation(reset = false) {
      placeholderRunId += 1;
      if (placeholderTimeoutId !== null) {
        window.clearTimeout(placeholderTimeoutId);
        placeholderTimeoutId = null;
      }
      placeholderTarget = '';
      placeholderRendered = '';
      isDeletingPlaceholder = false;
      if (reset && searchInput.value.trim() === '') {
        searchInput.placeholder = defaultSearchPlaceholder;
      }
    }

    function getRandomGamertag(): string {
      if (rotatingGamertags.length === 0) return '';
      while (scriptedPlaceholderIndex < scriptedPlaceholderGamertags.length) {
        const scripted = scriptedPlaceholderGamertags[scriptedPlaceholderIndex];
        scriptedPlaceholderIndex += 1;
        if (rotatingGamertags.includes(scripted)) {
          lastPlaceholderGamertag = scripted;
          return scripted;
        }
      }
      if (rotatingGamertags.length === 1) {
        lastPlaceholderGamertag = rotatingGamertags[0];
        return rotatingGamertags[0];
      }

      let next = lastPlaceholderGamertag;
      while (next === lastPlaceholderGamertag) {
        const index = Math.floor(Math.random() * rotatingGamertags.length);
        next = rotatingGamertags[index];
      }
      lastPlaceholderGamertag = next;
      return next;
    }

    function schedulePlaceholderTick(runId: number, delayMs: number) {
      placeholderTimeoutId = window.setTimeout(() => {
        if (runId !== placeholderRunId) return;
        if (!isSearchInputIdle()) {
          stopSearchPlaceholderRotation(true);
          return;
        }

        if (!placeholderTarget) {
          placeholderTarget = getRandomGamertag();
          placeholderRendered = '';
          isDeletingPlaceholder = false;
          if (!placeholderTarget) {
            searchInput.placeholder = defaultSearchPlaceholder;
            return;
          }
        }

        if (!isDeletingPlaceholder) {
          placeholderRendered = placeholderTarget.slice(0, placeholderRendered.length + 1);
          searchInput.placeholder = placeholderRendered;
          if (placeholderRendered === placeholderTarget) {
            isDeletingPlaceholder = true;
            schedulePlaceholderTick(runId, 2000);
            return;
          }
          schedulePlaceholderTick(runId, 70 + Math.floor(Math.random() * 70));
          return;
        }

        placeholderRendered = placeholderRendered.slice(0, -1);
        if (placeholderRendered.length > 0) {
          searchInput.placeholder = placeholderRendered;
          schedulePlaceholderTick(runId, 35 + Math.floor(Math.random() * 45));
          return;
        }

        searchInput.placeholder = defaultSearchPlaceholder;
        placeholderTarget = '';
        isDeletingPlaceholder = false;
        schedulePlaceholderTick(runId, 2000);
      }, delayMs);
    }

    function startSearchPlaceholderRotation() {
      if (!isSearchInputIdle() || rotatingGamertags.length === 0) return;
      stopSearchPlaceholderRotation();
      placeholderRunId += 1;
      const runId = placeholderRunId;
      searchInput.placeholder = defaultSearchPlaceholder;
      schedulePlaceholderTick(runId, 300);
    }

    type ShareData = {
      matchId: string;
      gamertag: string;
      resultText: string;
      resultClass: 'win' | 'loss' | 'draw';
      mapName: string;
      mapImage: string;
      mapImageFallback: string;
      leaderName: string;
      dateStr: string;
      durationStr: string;
      playlistLabel: string;
      teamSizeLabel: string;
      powersText: string;
      unitsText: string;
      shareUrl: string;
      shareTitle: string;
      shareText: string;
    };

    type TimelineEntry = {
      timeMs: number;
      playerIndex: number | null;
      playerName: string;
      teamId: number | null;
      label: string;
      kind: 'building' | 'upgrade' | 'unit' | 'unit_upgrade' | 'power' | 'veterancy';
      detail?: string;
    };

    type PlayerInfo = {
      name: string;
      teamId: number | null;
      playerType: number | null;
    };

    const STORAGE_KEY = 'hw2-recent-searches';
    const PINNED_MATCHES_KEY = 'hw2-pinned-matches';
    const MAX_RECENT = 5;
    const CURRENT_SEASON = [...seasonData].sort((a, b) => new Date(b.startDate).getTime() - new Date(a.startDate).getTime())[0];
    let leaderPowerMapCache: Record<string, string> | null = null;
    let leaderPowerNormalizedMap: Map<string, string> | null = null;
    let leaderPowerMapLoading: Promise<Record<string, string> | null> | null = null;
    let gameObjectMapCache: Record<string, string> | null = null;
    let gameObjectNormalizedMap: Map<string, string> | null = null;
    let gameObjectMapLoading: Promise<Record<string, string> | null> | null = null;
    let techMapCache: Record<string, string> | null = null;
    let techNormalizedMap: Map<string, string> | null = null;
    let techMapLoading: Promise<Record<string, string> | null> | null = null;
    let currentMatches: any[] = [];
    let currentGamertag = '';
    let matchLookup = new Map<string, any>();
    let matchEventsCache = new Map<string, any>();
    let activeShareData: ShareData | null = null;
    let shareStatusTimeout: number | null = null;
    let html2canvasPromise: Promise<any> | null = null;
    let mapImageRequestId = 0;
    let pendingShareMatchId: string | null = null;
    let shareMapImageDataUrl: string | null = null;
    let shareRequestId = 0;
    let shareMapImageUrl: string | null = null;
    let shareMapImagePromise: Promise<string | null> | null = null;

    async function ensureLeaderPowerMap(): Promise<Record<string, string> | null> {
      if (leaderPowerMapCache) return leaderPowerMapCache;
      if (leaderPowerMapLoading) return leaderPowerMapLoading;
      leaderPowerMapLoading = (async () => {
        const result = await getLeaderPowerMap();
        if (result.ok) {
          leaderPowerMapCache = result.data;
          leaderPowerNormalizedMap = new Map<string, string>();
          Object.entries(result.data).forEach(([id, name]) => {
            leaderPowerNormalizedMap!.set(normalizeLeaderPowerId(id), name);
          });
          return leaderPowerMapCache;
        }
        leaderPowerMapLoading = null;
        return null;
      })();
      return leaderPowerMapLoading;
    }

    function normalizeLeaderPowerId(powerId: string): string {
      return powerId.toLowerCase().replace(/[^a-z0-9]/g, '');
    }

    function humanizeLeaderPowerId(powerId: string): string {
      if (!powerId) return '';
      const normalized = powerId
        .replace(/_MP$/i, '')
        .replace(/_Proc$/i, '')
        .replace(/_/g, ' ')
        .replace(/([a-z])([A-Z])/g, '$1 $2')
        .replace(/([A-Z])([A-Z][a-z])/g, '$1 $2')
        .replace(/([a-zA-Z])(\d)\b/g, '$1 $2')
        .replace(/\s+/g, ' ')
        .trim();
      return normalized.replace(/\b(\d)\b/g, (match) => {
        switch (match) {
          case '1': return 'I';
          case '2': return 'II';
          case '3': return 'III';
          case '4': return 'IV';
          case '5': return 'V';
          default: return match;
        }
      });
    }

    function getLeaderPowerDisplayName(powerId: string, map?: Record<string, string> | null): string {
      if (!powerId) return '';
      if (map?.[powerId]) return map[powerId];

      const candidates = [
        powerId,
        powerId.replace(/_MP$/i, ''),
        powerId.replace(/_Proc$/i, ''),
      ];
      if (!/_MP$/i.test(powerId)) candidates.push(`${powerId}_MP`);
      if (!/_Proc$/i.test(powerId)) candidates.push(`${powerId}_Proc`);

      for (const candidate of candidates) {
        if (map?.[candidate]) return map[candidate];
        const normalized = normalizeLeaderPowerId(candidate);
        const normalizedHit = leaderPowerNormalizedMap?.get(normalized);
        if (normalizedHit) return normalizedHit;
        if (normalized.endsWith('mp')) {
          const noMp = normalized.slice(0, -2);
          const mpHit = leaderPowerNormalizedMap?.get(noMp);
          if (mpHit) return mpHit;
        } else {
          const mpHit = leaderPowerNormalizedMap?.get(`${normalized}mp`);
          if (mpHit) return mpHit;
        }
      }

      return humanizeLeaderPowerId(powerId);
    }

    async function ensureGameObjectMap(): Promise<Record<string, string> | null> {
      if (gameObjectMapCache) return gameObjectMapCache;
      if (gameObjectMapLoading) return gameObjectMapLoading;
      gameObjectMapLoading = (async () => {
        const result = await getGameObjectMap();
        if (result.ok) {
          gameObjectMapCache = result.data;
          gameObjectNormalizedMap = new Map<string, string>();
          Object.entries(result.data).forEach(([id, name]) => {
            gameObjectNormalizedMap!.set(normalizeGameObjectId(id), name);
          });
          return gameObjectMapCache;
        }
        gameObjectMapLoading = null;
        return null;
      })();
      return gameObjectMapLoading;
    }

    function normalizeGameObjectId(objectId: string): string {
      return objectId.toLowerCase().replace(/[^a-z0-9]/g, '');
    }

    function humanizeGameObjectId(objectId: string): string {
      if (!objectId) return '';
      const normalized = objectId
        .replace(/_MP$/i, '')
        .replace(/_Proc$/i, '')
        .replace(/_/g, ' ')
        .replace(/([a-z])([A-Z])/g, '$1 $2')
        .replace(/([A-Z])([A-Z][a-z])/g, '$1 $2')
        .replace(/([a-zA-Z])(\d)\b/g, '$1 $2')
        .replace(/\s+/g, ' ')
        .trim();
      return normalized;
    }

    function getGameObjectDisplayName(objectId: string, map?: Record<string, string> | null): string {
      if (!objectId) return '';
      if (map?.[objectId]) return map[objectId];
      const normalized = normalizeGameObjectId(objectId);
      const normalizedHit = gameObjectNormalizedMap?.get(normalized);
      if (normalizedHit) return normalizedHit;
      return humanizeGameObjectId(objectId);
    }

    async function ensureTechMap(): Promise<Record<string, string> | null> {
      if (techMapCache) return techMapCache;
      if (techMapLoading) return techMapLoading;
      techMapLoading = (async () => {
        const result = await getTechMap();
        if (result.ok) {
          techMapCache = result.data;
          techNormalizedMap = new Map<string, string>();
          Object.entries(result.data).forEach(([id, name]) => {
            techNormalizedMap!.set(normalizeTechId(id), name);
          });
          return techMapCache;
        }
        techMapLoading = null;
        return null;
      })();
      return techMapLoading;
    }

    function normalizeTechId(techId: string): string {
      return techId.toLowerCase().replace(/[^a-z0-9]/g, '');
    }

    function humanizeTechId(techId: string): string {
      if (!techId) return '';
      const normalized = techId
        .replace(/_MP$/i, '')
        .replace(/_Proc$/i, '')
        .replace(/_/g, ' ')
        .replace(/([a-z])([A-Z])/g, '$1 $2')
        .replace(/([A-Z])([A-Z][a-z])/g, '$1 $2')
        .replace(/([a-zA-Z])(\d)\b/g, '$1 $2')
        .replace(/\s+/g, ' ')
        .trim();
      return normalized;
    }

    function getTechDisplayName(techId: string, map?: Record<string, string> | null): string {
      if (!techId) return '';
      if (map?.[techId]) return map[techId];
      const normalized = normalizeTechId(techId);
      const normalizedHit = techNormalizedMap?.get(normalized);
      if (normalizedHit) return normalizedHit;
      return humanizeTechId(techId);
    }

    function getRecentSearches(): string[] {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      } catch { return []; }
    }

    function addRecentSearch(gt: string) {
      const searches = getRecentSearches().filter(s => s.toLowerCase() !== gt.toLowerCase());
      searches.unshift(gt);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(searches.slice(0, MAX_RECENT)));
      renderRecentSearches();
    }

    function getPinnedMatches(): string[] {
      try {
        return JSON.parse(localStorage.getItem(PINNED_MATCHES_KEY) || '[]');
      } catch { return []; }
    }

    function setPinnedMatches(ids: string[]) {
      localStorage.setItem(PINNED_MATCHES_KEY, JSON.stringify(ids));
    }

    function togglePinnedMatch(matchId: string): boolean {
      const pinned = new Set(getPinnedMatches());
      if (pinned.has(matchId)) {
        pinned.delete(matchId);
      } else {
        pinned.add(matchId);
      }
      setPinnedMatches([...pinned]);
      return pinned.has(matchId);
    }

    function renderRecentSearches() {
      const searches = getRecentSearches();
      if (searches.length === 0) {
        recentSearchesEl.classList.add('hidden');
        return;
      }
      recentSearchesEl.classList.remove('hidden');
      recentSearchesEl.innerHTML = '<span class="text-xs text-gray-400 self-center">Recent:</span>' +
        searches.map(s =>
          `<div class="recent-search-wrapper inline-flex items-center gap-1 text-xs px-3 py-1 rounded-full bg-slate-700/60 text-cyan-300 border border-cyan-500/20 hover:border-cyan-400/40 hover:bg-slate-600/60 transition-colors font-mono">
            <button type="button" class="recent-search-tag hover:text-cyan-200 transition-colors" data-gamertag="${s.replace(/"/g, '&quot;')}">${s}</button>
            <button type="button" class="recent-search-remove text-gray-400 hover:text-red-400 transition-colors ml-1" data-gamertag="${s.replace(/"/g, '&quot;')}" aria-label="Remove ${s} from recent searches">
              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>`
        ).join('');
      
      recentSearchesEl.querySelectorAll('.recent-search-tag').forEach(btn => {
        btn.addEventListener('click', () => {
          const gt = (btn as HTMLElement).dataset.gamertag || '';
          searchInput.value = gt;
          performSearch(gt);
        });
      });
      
      recentSearchesEl.querySelectorAll('.recent-search-remove').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const gt = (btn as HTMLElement).dataset.gamertag || '';
          removeRecentSearch(gt);
        });
      });
    }

    function removeRecentSearch(gamertagToRemove: string) {
      try {
        const searches = getRecentSearches();
        const filteredSearches = searches.filter(s => s.toLowerCase() !== gamertagToRemove.toLowerCase());
        localStorage.setItem(STORAGE_KEY, JSON.stringify(filteredSearches));
        renderRecentSearches();
      } catch {
        // Silently fail if localStorage is not available
      }
    }

    function showError(container: HTMLElement, error: { type: string; message: string }) {
      const colorMap: Record<string, string> = {
        not_found: 'border-red-500/40 bg-red-900/20 text-red-300',
        rate_limit: 'border-amber-500/40 bg-amber-900/20 text-amber-300',
        auth: 'border-blue-500/40 bg-blue-900/20 text-blue-300',
        network: 'border-blue-500/40 bg-blue-900/20 text-blue-300',
        unknown: 'border-red-500/40 bg-red-900/20 text-red-300',
      };
      const iconMap: Record<string, string> = {
        not_found: 'fa-user-slash',
        rate_limit: 'fa-clock',
        auth: 'fa-exclamation-triangle',
        network: 'fa-wifi',
        unknown: 'fa-exclamation-circle',
      };
      const classes = colorMap[error.type] || colorMap.unknown;
      const icon = iconMap[error.type] || iconMap.unknown;
      container.innerHTML = `
        <div class="rounded-lg border p-4 flex items-start gap-3 ${classes}">
          <i class="fas ${icon} mt-0.5" aria-hidden="true"></i>
          <div>
            <p class="font-medium">${error.message}</p>
          </div>
        </div>
      `;
      container.classList.remove('hidden');
    }

    function showSkeleton(sectionId: string) {
      const skeleton = document.getElementById(`${sectionId}-skeleton`);
      const content = document.getElementById(`${sectionId}-content`);
      const error = document.getElementById(`${sectionId}-error`);
      if (skeleton) skeleton.classList.remove('hidden');
      if (content) content.classList.add('hidden');
      if (error) { error.classList.add('hidden'); error.innerHTML = ''; }
    }

    function hideSkeleton(sectionId: string) {
      const skeleton = document.getElementById(`${sectionId}-skeleton`);
      if (skeleton) skeleton.classList.add('hidden');
    }

    function parseDurationParts(iso?: string) {
      if (!iso) return { weeks: 0, days: 0, hours: 0, minutes: 0, seconds: 0 };
      const match = iso.match(/P(?:(\d+)W)?(?:(\d+)D)?(?:T(?:(\d+)H)?(?:(\d+)M)?(?:(\d+(?:\.\d+)?)S)?)?/);
      if (!match) return { weeks: 0, days: 0, hours: 0, minutes: 0, seconds: 0 };
      return {
        weeks: parseInt(match[1] || '0'),
        days: parseInt(match[2] || '0'),
        hours: parseInt(match[3] || '0'),
        minutes: parseInt(match[4] || '0'),
        seconds: parseFloat(match[5] || '0'),
      };
    }

    function parseDuration(iso: string): string {
      const parts = parseDurationParts(iso);
      let totalSeconds = parts.seconds
        + parts.minutes * 60
        + parts.hours * 3600
        + (parts.days + parts.weeks * 7) * 86400;
      if (totalSeconds <= 0) return '0h';

      const totalDays = Math.floor(totalSeconds / 86400);
      totalSeconds -= totalDays * 86400;
      const hours = Math.floor(totalSeconds / 3600);
      totalSeconds -= hours * 3600;
      const minutes = Math.round(totalSeconds / 60);

      if (totalDays > 0) return hours > 0 ? `${totalDays}d ${hours}h` : `${totalDays}d`;
      if (hours > 0) return `${hours}h ${minutes}m`;
      if (minutes > 0) return `${minutes}m`;
      return '<1m';
    }

    function parseDurationHours(iso?: string): number {
      const parts = parseDurationParts(iso);
      return (parts.weeks * 7 + parts.days) * 24
        + parts.hours
        + parts.minutes / 60
        + parts.seconds / 3600;
    }

    function formatMatchClock(ms?: number): string {
      if (typeof ms !== 'number' || !Number.isFinite(ms)) return '';
      const totalSeconds = Math.max(0, Math.floor(ms / 1000));
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const seconds = totalSeconds % 60;
      if (hours > 0) {
        return `${hours}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
      }
      return `${minutes}:${String(seconds).padStart(2, '0')}`;
    }

    function getMatchmakingSummaries(statsData: any): any[] {
      if (Array.isArray(statsData)) {
        return statsData.filter((s: any) => s && s.PlaylistId);
      }
      const mm = statsData?.MatchmakingSummary;
      if (!mm) return [];
      const social = Array.isArray(mm.SocialPlaylistStats) ? mm.SocialPlaylistStats : [];
      const ranked = Array.isArray(mm.RankedPlaylistStats) ? mm.RankedPlaylistStats : [];
      return [...social, ...ranked];
    }

    function getCustomSummaries(statsData: any): any[] {
      const custom = statsData?.CustomSummary;
      if (!custom) return [];
      const summaries = [];
      if (custom.CustomStats) summaries.push(custom.CustomStats);
      const skirmish = custom.SkirmishStats;
      if (skirmish?.SinglePlayerStats) summaries.push(skirmish.SinglePlayerStats);
      if (skirmish?.MultiplayerStats) summaries.push(skirmish.MultiplayerStats);
      return summaries;
    }

    function sumSummaryTotals(summaries: any[]) {
      let matches = 0;
      let wins = 0;
      let time = 0;
      summaries.forEach((s: any) => {
        matches += getMatchesStarted(s);
        wins += getMatchesWon(s);
        time += parseDurationHours(getTotalTimePlayed(s));
      });
      return { matches, wins, time };
    }


    function buildLeaderStatsFromMatches(matches: any[]): Map<number, { matches: number; wins: number }> {
      const map = new Map<number, { matches: number; wins: number }>();
      if (!Array.isArray(matches)) return map;
      matches.forEach((match: any) => {
        if (match.MatchType != null && match.MatchType !== 3) return;
        const leaderId = match.LeaderId
          ?? match.Players?.[match.PlayerIndex || 0]?.LeaderId
          ?? match.Players?.[0]?.LeaderId;
        if (leaderId == null) return;
        const rawOutcome = match.PlayerMatchOutcome
          ?? match.MatchOutcome
          ?? match.MatchResult
          ?? match.Players?.[match.PlayerIndex || 0]?.MatchOutcome
          ?? match.Players?.[0]?.MatchOutcome;
        const outcome = typeof rawOutcome === 'string' ? rawOutcome.toLowerCase() : rawOutcome;
        const isWin = outcome === 1 || outcome === 'win' || outcome === 'victory';
        const prev = map.get(leaderId) || { matches: 0, wins: 0 };
        map.set(leaderId, { matches: prev.matches + 1, wins: prev.wins + (isWin ? 1 : 0) });
      });
      return map;
    }


    function renderLeaderRows(entries: Array<[number, { matches: number; wins: number }]>, maxCount: number, leaderColorMap?: Map<number, string>, showSwatch = false) {
      return entries.map(([leaderId, data]) => {
        const name = getLeaderName(leaderId);
        const pct = maxCount > 0 ? (data.matches / maxCount) * 100 : 0;
        const winRateValue = data.matches > 0 ? (data.wins / data.matches) * 100 : 0;
        const winRate = winRateValue.toFixed(1);
        const winPct = Math.min(100, Math.max(0, winRateValue));
        const leaderColor = leaderColorMap?.get(leaderId) || '#64748b';

        return `
          <div class="flex items-center gap-3">
            <div class="w-28 sm:w-36 flex items-center gap-2 flex-shrink-0">
              ${showSwatch ? `<span class="inline-block w-2.5 h-2.5 rounded-sm" style="background: ${leaderColor};"></span>` : ''}
              <span class="text-sm text-white truncate">${name}</span>
            </div>
            <div class="flex-1 h-6 bg-slate-700/30 rounded-full overflow-hidden">
              <div class="h-full rounded-full transition-all duration-500" style="width: ${pct}%; background: linear-gradient(90deg, rgba(34,197,94,0.85) 0%, rgba(34,197,94,0.85) ${winPct}%, rgba(239,68,68,0.85) ${winPct}%, rgba(239,68,68,0.85) 100%);"></div>
            </div>
            <span class="text-sm font-mono text-gray-300 w-10 text-right flex-shrink-0">${data.matches}</span>
            <span class="text-xs font-mono text-cyan-300 w-12 text-right flex-shrink-0">${winRate}%</span>
          </div>
        `;
      }).join('');
    }

    function getHighestTerminusWave(statsData: any): number {
      const mm = statsData?.MatchmakingSummary;
      const socialMode = Array.isArray(mm?.SocialModeStats) ? mm.SocialModeStats : [];
      const rankedMode = Array.isArray(mm?.RankedModeStats) ? mm.RankedModeStats : [];
      const custom = statsData?.CustomSummary;
      const customMode = Array.isArray(custom?.CustomModeStats) ? custom.CustomModeStats : [];
      const skirmish = custom?.SkirmishStats;
      const skirmishSingle = Array.isArray(skirmish?.SinglePlayerModeStats) ? skirmish.SinglePlayerModeStats : [];
      const skirmishMulti = Array.isArray(skirmish?.MultiplayerModeStats) ? skirmish.MultiplayerModeStats : [];
      const modeStats = [
        ...socialMode,
        ...rankedMode,
        ...customMode,
        ...skirmishSingle,
        ...skirmishMulti,
      ];

      let maxWave = 0;
      modeStats.forEach((s: any) => {
        if (s?.GameMode !== 10) return;
        const wave = s?.HighestWaveCompleted ?? 0;
        if (wave > maxWave) maxWave = wave;
      });

      return maxWave;
    }

    function getMatchesStarted(stat: any): number {
      return stat?.TotalMatchesStarted ?? stat?.MatchesStarted ?? 0;
    }

    function getMatchesWon(stat: any): number {
      return stat?.TotalMatchesWon ?? stat?.MatchesWon ?? 0;
    }

    function getMatchesLost(stat: any): number {
      return stat?.TotalMatchesLost ?? stat?.MatchesLost ?? 0;
    }

    function getMatchesCompleted(stat: any): number {
      return stat?.TotalMatchesCompleted ?? stat?.MatchesCompleted ?? 0;
    }

    function getTotalTimePlayed(stat: any): string {
      return stat?.TotalTimePlayed || 'PT0S';
    }

    function getGameModeName(mode?: number): string {
      switch (mode) {
        case 1: return 'Campaign Solo';
        case 2: return 'Campaign Co-op';
        case 3: return 'Deathmatch';
        case 4: return 'Domination';
        case 5: return 'Strongholds';
        case 6: return 'Blitz';
        case 7: return 'Firefight';
        case 8: return 'Tutorial';
        case 9: return 'Blitz Tutorial';
        case 10: return 'Terminus Firefight';
        default: return '';
      }
    }

    function findMatchPlayer(match: any, gamertag: string) {
      const gtLower = gamertag.toLowerCase();
      const rawPlayers = match?.Players;
      const players = Array.isArray(rawPlayers)
        ? rawPlayers
        : (rawPlayers && typeof rawPlayers === 'object')
          ? Object.values(rawPlayers)
          : [];
      const player = players.find((p: any) => {
        const id =
          p?.HumanPlayerId?.Gamertag
          || (typeof p?.HumanPlayerId === 'string' ? p.HumanPlayerId : '')
          || p?.Gamertag
          || p?.PlayerId;
        return id && String(id).toLowerCase() === gtLower;
      }) || players[0] || null;
      return player;
    }

    function buildMatchShareData(match: any, gamertag: string): ShareData {
      const player = findMatchPlayer(match, gamertag);

      const rawOutcome = player?.MatchOutcome
        ?? player?.PlayerMatchOutcome
        ?? match.PlayerMatchOutcome
        ?? match.MatchOutcome
        ?? match.MatchResult;
      const outcome = typeof rawOutcome === 'string' ? rawOutcome.toLowerCase() : rawOutcome;
      const isWin = outcome === 1 || outcome === 'win' || outcome === 'victory';
      const isLoss = outcome === 2 || outcome === 'loss' || outcome === 'defeat';
      const resultText = isWin ? 'Victory' : isLoss ? 'Defeat' : 'Draw';
      const resultClass: ShareData['resultClass'] = isWin ? 'win' : isLoss ? 'loss' : 'draw';

      const leaderId = player?.LeaderId ?? match.LeaderId;
      const leaderName = leaderId != null ? getLeaderName(leaderId) : 'Unknown';
      const mapName = getMapName(match.MapId || '');
      const mapImage =
        getMapImage(match.MapId || '')
        || (typeof match.MapImageUrl === 'string' ? match.MapImageUrl : '')
        || (typeof match.MapImage === 'string' ? match.MapImage : '');
      const mapImageFallback =
        getMapImageFallback(match.MapId || '')
        || (typeof match.MapImageUrl === 'string' ? match.MapImageUrl : '')
        || (typeof match.MapImage === 'string' ? match.MapImage : '');
      const dateStr = match.MatchStartDate?.ISO8601Date
        ? new Date(match.MatchStartDate.ISO8601Date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
        : '';
      const durationIso = match.PlayerMatchDuration || match.MatchDuration;
      const durationStr = durationIso ? parseDuration(durationIso) : '';

      const playlistName = match.PlaylistId ? getPlaylistName(match.PlaylistId) : '';
      const fallbackLabel = getGameModeName(match.GameMode) || (match.MatchType === 3 ? 'Matchmaking' : match.MatchType === 2 ? 'Custom' : match.MatchType === 1 ? 'Campaign' : 'Unknown');
      const playlistLabel = playlistName || fallbackLabel;

      let powersUsed = 0;
      const leaderPowerStats = player?.LeaderPowerStats;
      if (leaderPowerStats && typeof leaderPowerStats === 'object') {
        Object.values(leaderPowerStats).forEach((stats: any) => {
          if (typeof stats === 'number') {
            powersUsed += stats;
          } else if (stats && typeof stats === 'object') {
            powersUsed += stats.TimesCast ?? stats.TotalPlays ?? 0;
          }
        });
      }
      const powersText = String(powersUsed);

      const unitStats = player?.UnitStats || match.UnitStats;
      let unitsDestroyed = 0;
      if (unitStats && typeof unitStats === 'object') {
        Object.values(unitStats).forEach((u: any) => {
          unitsDestroyed += u?.TotalDestroyed || 0;
        });
      }
      const unitsText = String(unitsDestroyed);

      let teamSizeLabel = '';
      if (match.Teams && typeof match.Teams === 'object') {
        const sizes = Object.values(match.Teams).map((t: any) => t?.TeamSize).filter((s: any) => typeof s === 'number');
        if (sizes.length >= 2) {
          teamSizeLabel = `${sizes[0]}v${sizes[1]}`;
        } else if (sizes.length === 1) {
          teamSizeLabel = `${sizes[0]}v${sizes[0]}`;
        }
      }

      const matchId = match.MatchId || '';
      const baseUrl = `${window.location.origin}/halo-wars-stats`;
      const shareUrl = `${baseUrl}?gamertag=${encodeURIComponent(gamertag)}${matchId ? `&matchId=${encodeURIComponent(matchId)}` : ''}`;
      const shareTitle = `${gamertag} - ${resultText} as ${leaderName} on ${mapName} | Halo Wars 2 Stats`;
      const shareText = `${gamertag} - ${resultText} on ${mapName} as ${leaderName}${durationStr ? ` | ${durationStr}` : ''}${teamSizeLabel ? ` | ${teamSizeLabel}` : ''}`;

      return {
        matchId,
        gamertag,
        resultText,
        resultClass,
        mapName,
        mapImage,
        mapImageFallback,
        leaderName,
        dateStr,
        durationStr,
        playlistLabel,
        teamSizeLabel: teamSizeLabel || '-',
        powersText,
        unitsText,
        shareUrl,
        shareTitle,
        shareText,
      };
    }

    function setShareStatus(message: string, tone: 'ok' | 'error' | 'info' = 'info') {
      if (!shareStatusEl) return;
      shareStatusEl.textContent = message;
      shareStatusEl.classList.remove('ok', 'error');
      if (tone !== 'info') shareStatusEl.classList.add(tone);
      if (shareStatusTimeout) {
        window.clearTimeout(shareStatusTimeout);
      }
      if (message) {
        shareStatusTimeout = window.setTimeout(() => {
          if (shareStatusEl) {
            shareStatusEl.textContent = '';
            shareStatusEl.classList.remove('ok', 'error');
          }
        }, 3000);
      }
    }

    function setShareCardLoading(isLoading: boolean) {
      if (!shareCard) return;
      shareCard.classList.toggle('share-loading', isLoading);
    }

    function updateShareCard(data: ShareData) {
      if (shareResultEl) {
        shareResultEl.textContent = data.resultText;
        shareResultEl.classList.remove('win', 'loss', 'draw');
        shareResultEl.classList.add(data.resultClass);
      }
      if (shareGamertagEl) shareGamertagEl.textContent = data.gamertag;
      if (shareSubtitleEl) shareSubtitleEl.textContent = `${data.leaderName} | ${data.mapName}`;
      if (shareMapEl) shareMapEl.textContent = data.mapName;
      if (shareLeaderEl) shareLeaderEl.textContent = data.leaderName;
      if (shareDurationEl) shareDurationEl.textContent = data.durationStr || '-';
      if (sharePowersEl) sharePowersEl.textContent = data.powersText || '-';
      if (shareUnitsEl) shareUnitsEl.textContent = data.unitsText || '-';
      if (shareTeamEl) shareTeamEl.textContent = data.teamSizeLabel || '-';
      if (sharePlaylistEl) sharePlaylistEl.textContent = data.playlistLabel || 'Matchmaking';
      if (shareDateEl) shareDateEl.textContent = data.dateStr || '';
    }

    function updateShareLinks(data: ShareData) {
      const encodedUrl = encodeURIComponent(data.shareUrl);
      const encodedTitle = encodeURIComponent(data.shareTitle);
      const encodedText = encodeURIComponent(data.shareText);
      const linkMap: Record<string, string> = {
        x: `https://twitter.com/intent/tweet?url=${encodedUrl}&text=${encodedText}`,
        facebook: `https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}`,
        linkedin: `https://www.linkedin.com/sharing/share-offsite/?url=${encodedUrl}`,
        reddit: `https://www.reddit.com/submit?url=${encodedUrl}&title=${encodedTitle}`,
      };

      shareLinks.forEach((link) => {
        const key = link.getAttribute('data-share') || '';
        if (key && linkMap[key]) {
          link.setAttribute('href', linkMap[key]);
        }
      });
    }

    async function resolveShareMapImage(url: string): Promise<string | null> {
      if (!url) return null;
      try {
        const response = await fetch(url, { mode: 'cors' });
        if (!response.ok) return null;
        const blob = await response.blob();
        return await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(String(reader.result || ''));
          reader.onerror = () => reject(new Error('Failed to read image.'));
          reader.readAsDataURL(blob);
        });
      } catch {
        return null;
      }
    }

    async function setShareMapImage(url: string, fallbackUrl = '') {
      if (!shareHeroEl) return;
      const requestId = ++mapImageRequestId;
      const primaryUrl = url || '';
      const backupUrl = fallbackUrl || '';
      shareMapImageDataUrl = null;
      shareMapImageUrl = primaryUrl || backupUrl || null;
      shareMapImagePromise = null;

      if (primaryUrl) {
        shareHeroEl.style.backgroundImage = `url('${primaryUrl}')`;
      } else if (backupUrl) {
        shareHeroEl.style.backgroundImage = `url('${backupUrl}')`;
      } else {
        shareHeroEl.style.backgroundImage = SHARE_HERO_GRADIENT;
      }

      shareMapImagePromise = (async () => {
        if (primaryUrl) {
          const primaryData = await resolveShareMapImage(primaryUrl);
          if (primaryData) return primaryData;
        }
        if (backupUrl) {
          return await resolveShareMapImage(backupUrl);
        }
        return null;
      })();

      const dataUrl = await shareMapImagePromise;
      if (requestId !== mapImageRequestId) return;
      if (dataUrl) {
        shareMapImageDataUrl = dataUrl;
        shareHeroEl.style.backgroundImage = `url('${dataUrl}')`;
      } else if (backupUrl) {
        shareHeroEl.style.backgroundImage = `url('${backupUrl}')`;
      }
    }

    function preloadShareImage(src: string): Promise<boolean> {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => resolve(true);
        img.onerror = () => resolve(false);
        img.src = src;
      });
    }

    async function ensureShareMapImageReady(): Promise<string | null> {
      if (shareMapImageDataUrl) {
        await preloadShareImage(shareMapImageDataUrl);
        return shareMapImageDataUrl;
      }
      if (shareMapImagePromise) {
        const dataUrl = await shareMapImagePromise;
        if (dataUrl) {
          shareMapImageDataUrl = dataUrl;
          await preloadShareImage(dataUrl);
          return dataUrl;
        }
      }
      return null;
    }

    function openShareModal(data: ShareData) {
      if (!shareModal) return;
      activeShareData = data;
      updateShareCard(data);
      updateShareLinks(data);
      setShareCardLoading(false);
      if (shareCopyLinkBtn) shareCopyLinkBtn.setAttribute('data-url', data.shareUrl);
      shareModal.classList.remove('hidden');
      shareModal.setAttribute('aria-hidden', 'false');
      document.body.classList.add('match-share-open');
      setShareStatus('');
      setShareMapImage(data.mapImage, data.mapImageFallback);
      shareCopyLinkBtn?.focus();
    }

    function closeShareModal() {
      if (!shareModal) return;
      shareModal.classList.add('hidden');
      shareModal.setAttribute('aria-hidden', 'true');
      document.body.classList.remove('match-share-open');
      activeShareData = null;
      setShareStatus('');
    }

    async function ensureHtml2canvas(): Promise<any> {
      const existing = (window as any).html2canvas;
      if (existing) return existing;
      if (html2canvasPromise) return html2canvasPromise;
      html2canvasPromise = new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
        script.async = true;
        script.onload = () => resolve((window as any).html2canvas);
        script.onerror = () => reject(new Error('Failed to load image capture library.'));
        document.head.appendChild(script);
      });
      return html2canvasPromise;
    }

    function canvasToBlob(canvas: HTMLCanvasElement): Promise<Blob> {
      return new Promise((resolve, reject) => {
        canvas.toBlob((blob) => {
          if (blob) resolve(blob);
          else reject(new Error('Unable to generate image.'));
        }, 'image/png');
      });
    }

    async function renderShareCardCanvas(): Promise<HTMLCanvasElement> {
      if (!shareCard) throw new Error('Share card not found.');
      const html2canvas = await ensureHtml2canvas();
      const previousBg = shareHeroEl?.style.backgroundImage;
      if (shareHeroEl) {
        const dataUrl = await ensureShareMapImageReady();
        if (dataUrl) {
          shareHeroEl.style.backgroundImage = `url('${dataUrl}')`;
        } else if (!shareHeroEl.style.backgroundImage) {
          shareHeroEl.style.backgroundImage = SHARE_HERO_GRADIENT;
        }
      }
      try {
        return await html2canvas(shareCard, {
          backgroundColor: null,
          scale: 2,
          useCORS: true,
        });
      } finally {
        if (shareHeroEl && typeof previousBg === 'string') {
          shareHeroEl.style.backgroundImage = previousBg;
        }
      }
    }

    async function copyShareLink() {
      if (!activeShareData) return;
      try {
        await navigator.clipboard.writeText(activeShareData.shareUrl);
        setShareStatus('Link copied to clipboard.', 'ok');
      } catch {
        setShareStatus('Failed to copy link.', 'error');
      }
    }

    async function downloadShareImage() {
      if (!activeShareData) return;
      try {
        const mapWarning = !!activeShareData.mapImage && !shareMapImageDataUrl;
        setShareStatus(mapWarning ? 'Preparing map art for export...' : 'Generating image...', 'info');
        const canvas = await renderShareCardCanvas();
        const blob = await canvasToBlob(canvas);
        const safeGamertag = activeShareData.gamertag.replace(/[^a-z0-9]+/gi, '-').replace(/^-+|-+$/g, '');
        const safeMatch = activeShareData.matchId ? activeShareData.matchId.slice(0, 8) : 'match';
        const fileName = `hw2-${safeGamertag || 'player'}-${safeMatch}.png`;
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = fileName;
        link.click();
        URL.revokeObjectURL(url);
        setShareStatus('Image downloaded.', 'ok');
      } catch (err) {
        setShareStatus('Unable to generate image.', 'error');
      }
    }

    async function copyShareImage() {
      if (!activeShareData) return;
      if (!navigator.clipboard || !(window as any).ClipboardItem) {
        setShareStatus('Copy image is not supported in this browser.', 'error');
        return;
      }
      if (!window.isSecureContext) {
        setShareStatus('Copy image requires HTTPS.', 'error');
        return;
      }
      try {
        const mapWarning = !!activeShareData.mapImage && !shareMapImageDataUrl;
        setShareStatus(mapWarning ? 'Preparing map art for export...' : 'Generating image...', 'info');
        const canvas = await renderShareCardCanvas();
        const blob = await canvasToBlob(canvas);
        const item = new (window as any).ClipboardItem({ 'image/png': blob });
        await navigator.clipboard.write([item]);
        setShareStatus('Image copied to clipboard.', 'ok');
      } catch {
        setShareStatus('Unable to copy image.', 'error');
      }
    }

    async function showShareModal(matchId: string, gamertag: string) {
      if (!matchId) return;
      const match = matchLookup.get(matchId) || currentMatches.find((m: any) => m.MatchId === matchId);
      if (!match) {
        showError(globalError, { type: 'not_found', message: 'Match not found in recent history.' });
        return;
      }
      const requestId = ++shareRequestId;
      const data = buildMatchShareData(match, gamertag);
      openShareModal(data);

      const player = findMatchPlayer(match, gamertag);
      const needsDetails = !player || (!player?.UnitStats && !player?.LeaderPowerStats);
      setShareCardLoading(needsDetails);
      if (!needsDetails) return;

      setShareStatus('Fetching match details...', 'info');
      const result = await getMatchResult(matchId);
      if (requestId !== shareRequestId) return;
      if (!result.ok || !result.data) {
        setShareStatus('Match details unavailable.', 'error');
        setShareCardLoading(false);
        return;
      }

      const mergedMatch = {
        ...match,
        ...result.data,
        Players: result.data?.Players ?? match.Players,
      };
      const updated = buildMatchShareData(mergedMatch, gamertag);
      activeShareData = updated;
      updateShareCard(updated);
      updateShareLinks(updated);
      if (shareCopyLinkBtn) shareCopyLinkBtn.setAttribute('data-url', updated.shareUrl);
      setShareMapImage(updated.mapImage, updated.mapImageFallback);
      setShareStatus('Match details loaded.', 'ok');
      setShareCardLoading(false);
    }

    if (shareModal) {
      shareModal.querySelectorAll('[data-close="true"]').forEach((el) => {
        el.addEventListener('click', closeShareModal);
      });
    }

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && shareModal && !shareModal.classList.contains('hidden')) {
        closeShareModal();
      }
    });

    shareCopyLinkBtn?.addEventListener('click', copyShareLink);
    shareDownloadBtn?.addEventListener('click', downloadShareImage);
    shareCopyImageBtn?.addEventListener('click', copyShareImage);

    function renderOverview(stats: any) {
      hideSkeleton('overview');
      const overviewContent = document.getElementById('overview-content')!;
      const overviewError = document.getElementById('overview-error')!;

      const summaries = getMatchmakingSummaries(stats);
      const allSummaries = [...summaries, ...getCustomSummaries(stats)];
      if (summaries.length === 0) {
        showError(overviewError, { type: 'not_found', message: 'No matchmaking stats found for this player.' });
        return;
      }

      const mmTotals = sumSummaryTotals(summaries);
      const allTotals = allSummaries.length > 0 ? sumSummaryTotals(allSummaries) : mmTotals;
      const mmLosses = Math.max(0, mmTotals.matches - mmTotals.wins);

        const winRateValue = mmTotals.matches > 0 ? (mmTotals.wins / mmTotals.matches) * 100 : 0;
        const winRate = winRateValue.toFixed(1);
        const timeStr = mmTotals.time >= 1 ? `${Math.round(mmTotals.time)}h` : '<1h';
        const allTimeStr = allTotals.time >= 1 ? `${Math.round(allTotals.time)}h` : '<1h';
        const avgMatchSeconds = mmTotals.matches > 0 ? Math.round((mmTotals.time / mmTotals.matches) * 3600) : 0;
        const avgMatchStr = avgMatchSeconds > 0 ? parseDuration(`PT${avgMatchSeconds}S`) : '-';
        const terminusWave = getHighestTerminusWave(stats);
        const winRateLabel =
          winRateValue >= 60
            ? 'Sweaty Pro Player'
            : winRateValue > 45
              ? 'Average TR viewer'
              : 'Cringe worthy bad';

      document.getElementById('stat-matches')!.textContent = mmTotals.matches.toLocaleString();
      document.getElementById('stat-wins')!.textContent = mmTotals.wins.toLocaleString();
        document.getElementById('stat-losses')!.textContent = mmLosses.toLocaleString();
        document.getElementById('stat-winrate')!.textContent = `${winRate}%`;
        document.getElementById('stat-winrate-label')!.textContent = winRateLabel;
        document.getElementById('stat-time')!.textContent = timeStr;
      document.getElementById('stat-time-all')!.textContent = `All modes: ${allTimeStr}`;
      document.getElementById('stat-avg-match')!.textContent = avgMatchStr;
      document.getElementById('stat-terminus-wave')!.textContent = terminusWave > 0 ? String(terminusWave) : '-';
      overviewContent.classList.remove('hidden');
    }

    function renderRankedStats(stats: any, seasonStats?: any) {
      hideSkeleton('ranked');
      const rankedContent = document.getElementById('ranked-content')!;
      const rankedError = document.getElementById('ranked-error')!;

      const playlistIds = [
        { id: PLAYLIST_1V1_RANKED, label: '1v1 Ranked' },
        { id: PLAYLIST_2V2_RANKED, label: '2v2 Ranked' },
        { id: PLAYLIST_3V3_RANKED, label: '3v3 Ranked' },
      ];

      const summaries = getMatchmakingSummaries(stats);
      const rankedStats = summaries.filter((s: any) => s.PlaylistId && playlistIds.some(p => p.id === s.PlaylistId));

      const seasonRanked = seasonStats?.RankedPlaylistStats || [];
      const seasonLabel = CURRENT_SEASON ? getSeasonName(CURRENT_SEASON.id) : 'Current Season';

      const buildCard = (stat: any, label: string, subLabel: string, emptyText: string) => {
        if (!stat) {
          return `
            <div class="rounded-xl p-6 border border-cyan-500/20 text-center" style="background: rgba(30, 41, 59, 0.4);">
              <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-2">${label}</h3>
              <p class="text-[10px] text-gray-500 uppercase tracking-wider mb-4">${subLabel}</p>
              <p class="text-gray-500 text-sm">${emptyText}</p>
            </div>
          `;
        }

        const csr = stat.CurrentCsr || stat.HighestCsr || { Designation: 0, Tier: 0 };
        const tier = getCsrTier(csr.Designation, csr.Tier);
        const wins = getMatchesWon(stat);
        const losses = getMatchesLost(stat);
        const total = getMatchesCompleted(stat) || (wins + losses);
        const wr = total > 0 ? ((wins / total) * 100).toFixed(1) : '0.0';

        return `
          <div class="rounded-xl p-6 border border-cyan-500/20 text-center" style="background: rgba(30, 41, 59, 0.4);">
            <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-2">${label}</h3>
            <p class="text-[10px] text-gray-500 uppercase tracking-wider mb-4">${subLabel}</p>
            <div class="csr-glow rounded-full w-20 h-20 mx-auto mb-3 flex items-center justify-center bg-slate-800/60 border border-cyan-500/30">
              ${tier.imageUrl
                ? `<img src="${tier.imageUrl}" alt="${tier.title}" class="w-16 h-16 object-contain" loading="lazy" />`
                : `<span class="text-cyan-400 text-xs font-mono">${tier.title}</span>`
              }
            </div>
            <p class="text-cyan-300 font-semibold font-mono text-sm mb-1">${tier.title}</p>
            ${csr.Raw ? `<p class="text-xs text-gray-400 font-mono mb-2">CSR: ${Math.round(csr.Raw)}</p>` : ''}
            <div class="flex justify-center gap-4 text-xs">
              <span class="text-green-400 font-mono">${wins}W</span>
              <span class="text-red-400 font-mono">${losses}L</span>
              <span class="text-cyan-300 font-mono">${wr}%</span>
            </div>
          </div>
        `;
      };

      const lifetimeCards = playlistIds.map(p => {
        const stat = rankedStats.find((s: any) => s.PlaylistId === p.id);
        return buildCard(stat, p.label, 'All-Time High', 'No ranked data');
      });

      const seasonCards = playlistIds.map(p => {
        const stat = seasonRanked.find((s: any) => s.PlaylistId === p.id);
        return buildCard(stat, p.label, seasonLabel, 'No season data');
      });

      rankedContent.innerHTML = [...lifetimeCards, ...seasonCards].join('');
      rankedContent.classList.remove('hidden');
    }

    function renderLeaderUsage(matches?: any[]) {
      hideSkeleton('leaders');
      const leadersContent = document.getElementById('leaders-content')!;

      const recentMatches = Array.isArray(matches) ? matches : [];
      const recentMatchCount = recentMatches.filter((m: any) => m.MatchType == null || m.MatchType === 3).length;
      const recentMap = buildLeaderStatsFromMatches(recentMatches);
      const recentEntries = [...recentMap.entries()].filter(([, data]) => data.matches > 0).sort((a, b) => b[1].matches - a[1].matches);
      const recentMax = recentEntries.length ? recentEntries[0][1].matches : 0;

      const headerHtml = `
        <div class="flex items-baseline justify-between mb-3">
          <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Recent Leader Usage</h3>
          <span class="text-xs text-gray-500">Last ${recentMatchCount} matches</span>
        </div>
      `;

      leadersContent.innerHTML = recentEntries.length
        ? headerHtml + `<div class="space-y-3">${renderLeaderRows(recentEntries, recentMax)}</div>`
        : headerHtml + '<p class="text-gray-500 text-sm text-center py-4">No recent leader data.</p>';
      leadersContent.classList.remove('hidden');
    }

    function renderMatches(matches: any[], gamertag: string) {
      hideSkeleton('matches');
      const matchesContent = document.getElementById('matches-content')!;
      currentMatches = Array.isArray(matches) ? matches : [];
      currentGamertag = gamertag;
      matchLookup = new Map<string, any>();
      currentMatches.forEach((m: any) => {
        const id = m?.MatchId;
        if (id) matchLookup.set(id, m);
      });

      if (!matches || matches.length === 0) {
        matchesContent.innerHTML = '<p class="text-gray-500 text-sm text-center py-6">No recent matches found.</p>';
        matchesContent.classList.remove('hidden');
        return;
      }

      const pinnedSet = new Set(getPinnedMatches());
      const pinnedMatches = currentMatches.filter((m: any) => m?.MatchId && pinnedSet.has(m.MatchId));
      const unpinnedMatches = currentMatches.filter((m: any) => !m?.MatchId || !pinnedSet.has(m.MatchId));
      const displayMatches = [...pinnedMatches, ...unpinnedMatches];

      matchesContent.innerHTML = '<div class="divide-y divide-slate-700/30">' + displayMatches.map((match: any, i: number) => {
        const gtLower = gamertag.toLowerCase();
        const player = match.Players?.find((p: any) => {
          const id = p.HumanPlayerId || p.Gamertag || p.PlayerId;
          return id && String(id).toLowerCase() === gtLower;
        }) || match.Players?.[0] || null;

        const rawOutcome = player?.MatchOutcome
          ?? player?.PlayerMatchOutcome
          ?? match.PlayerMatchOutcome
          ?? match.MatchOutcome
          ?? match.MatchResult;
        const outcome = typeof rawOutcome === 'string' ? rawOutcome.toLowerCase() : rawOutcome;
        const isWin = outcome === 1 || outcome === 'win' || outcome === 'victory';
        const isLoss = outcome === 2 || outcome === 'loss' || outcome === 'defeat';
        const resultText = isWin ? 'Victory' : isLoss ? 'Defeat' : 'Draw';
        const resultColor = isWin ? 'text-green-400' : isLoss ? 'text-red-400' : 'text-gray-400';
        const borderColor = isWin ? '#22c55e' : isLoss ? '#ef4444' : '#6b7280';

        const leaderId = player?.LeaderId ?? match.LeaderId;
        const leaderName = leaderId != null ? getLeaderName(leaderId) : 'Unknown';
        const mapName = getMapName(match.MapId || '');
        const mapImg = getMapImage(match.MapId || '');
        const mapFallback = getMapImageFallback(match.MapId || '');
        const fallbackAttr = mapFallback ? ` data-fallback="${mapFallback}"` : '';
        const dateStr = match.MatchStartDate?.ISO8601Date
          ? new Date(match.MatchStartDate.ISO8601Date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
          : '';
        const durationIso = match.PlayerMatchDuration || match.MatchDuration;
        const durationStr = durationIso ? parseDuration(durationIso) : '';

        const playlistName = match.PlaylistId ? getPlaylistName(match.PlaylistId) : '';
        const fallbackLabel = getGameModeName(match.GameMode) || (match.MatchType === 3 ? 'Matchmaking' : match.MatchType === 2 ? 'Custom' : match.MatchType === 1 ? 'Campaign' : 'Unknown');
        const playlistLabel = playlistName || fallbackLabel;

        const prevCsr = match.RatingProgress?.PreviousCsr?.Raw;
        const nextCsr = match.RatingProgress?.UpdatedCsr?.Raw;
        const csrDelta = (typeof prevCsr === 'number' && typeof nextCsr === 'number') ? Math.round(nextCsr - prevCsr) : null;
        const csrDeltaText = csrDelta != null ? `${csrDelta > 0 ? '+' : ''}${csrDelta}` : '';
        const csrDeltaClass = csrDelta == null ? 'text-gray-500' : csrDelta > 0 ? 'text-green-400' : csrDelta < 0 ? 'text-red-400' : 'text-gray-400';

        const unitStats = player?.UnitStats || match.UnitStats;
        let unitsDestroyed = 0;
        let unitsLost = 0;
        if (unitStats && typeof unitStats === 'object') {
          Object.values(unitStats).forEach((u: any) => {
            unitsDestroyed += u?.TotalDestroyed || 0;
            unitsLost += u?.TotalLost || 0;
          });
        }
        const unitsText = (unitsDestroyed || unitsLost) ? `${unitsDestroyed}D / ${unitsLost}L` : '';

        const completed = player?.PlayerCompletedMatch ?? match.PlayerCompletedMatch;
        const completionTag = completed == null
          ? ''
          : completed
            ? '<span class="text-green-400">Completed</span>'
            : '<span class="text-red-400">Left Early</span>';

        let teamSizeLabel = '';
        if (match.Teams && typeof match.Teams === 'object') {
          const sizes = Object.values(match.Teams).map((t: any) => t?.TeamSize).filter((s: any) => typeof s === 'number');
          if (sizes.length >= 2) {
            teamSizeLabel = `${sizes[0]}v${sizes[1]}`;
          } else if (sizes.length === 1) {
            teamSizeLabel = `${sizes[0]}v${sizes[0]}`;
          }
        }

        const matchId = match.MatchId || '';
        const detailsId = matchId ? `match-details-${matchId}` : '';
        const timelineId = matchId ? `match-timeline-${matchId}` : '';
        const isPinned = matchId ? pinnedSet.has(matchId) : false;
        const pinLabel = isPinned ? 'Pinned' : 'Pin';
        const pinClass = isPinned
          ? 'text-amber-200 border-amber-400/40 bg-amber-400/10'
          : 'text-cyan-300 border-cyan-500/20 bg-slate-800/40 hover:text-cyan-200 hover:border-cyan-400/40';
        const bgClass = i % 2 === 0 ? 'bg-slate-800/20' : '';

          return `
            <div class="${bgClass} hover:bg-slate-700/20 transition-colors" style="border-left: 4px solid ${borderColor};">
              <div class="flex items-start gap-4 p-4">
                ${mapImg
                  ? `<img src="${mapImg}" alt="${mapName}"${fallbackAttr} class="w-16 h-10 sm:w-20 sm:h-12 rounded object-cover flex-shrink-0 border border-slate-600/30" loading="lazy" />`
                  : `<div class="w-16 h-10 sm:w-20 sm:h-12 rounded bg-slate-700/50 flex-shrink-0 flex items-center justify-center text-xs text-gray-500">${mapName}</div>`
                }
                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-2 flex-wrap">
                    <span class="font-semibold ${resultColor} text-sm">${resultText}</span>
                    <span class="text-gray-400 text-xs">on</span>
                    <span class="text-white text-sm truncate">${mapName}</span>
                  </div>
                  <div class="flex items-center gap-3 text-xs text-gray-400 mt-1 flex-wrap">
                    <span>${leaderName}</span>
                    ${dateStr ? `<span>${dateStr}</span>` : ''}
                    ${durationStr ? `<span> ${durationStr}</span>` : ''}
                    ${teamSizeLabel ? `<span> ${teamSizeLabel}</span>` : ''}
                    ${completionTag ? `<span> ${completionTag}</span>` : ''}
                    ${playlistLabel ? `<span class="text-cyan-300"> ${playlistLabel}</span>` : ''}
                    ${csrDeltaText ? `<span class="${csrDeltaClass}"> CSR ${csrDeltaText}</span>` : ''}
                    ${unitsText ? `<span> Units ${unitsText}</span>` : ''}
                  </div>
                  ${matchId ? `
                    <div class="flex flex-wrap gap-2 mt-3">
                      <button
                        type="button"
                        class="match-details-toggle flex-[4] flex items-center justify-between rounded-md border border-cyan-500/20 bg-slate-800/40 px-3 py-2 text-xs text-cyan-300 hover:text-cyan-200 hover:border-cyan-400/40 transition-colors"
                        data-match-id="${matchId}"
                        aria-controls="${detailsId}"
                        aria-expanded="false"
                      >
                        <span>Team Compositions and Stats</span>
                        <span class="match-details-chevron transition-transform duration-200" aria-hidden="true">&#x25BC;</span>
                      </button>
                      <button
                        type="button"
                        class="match-timeline-toggle flex-[3] flex items-center justify-between rounded-md border border-cyan-500/20 bg-slate-800/40 px-3 py-2 text-xs text-cyan-300 hover:text-cyan-200 hover:border-cyan-400/40 transition-colors"
                        data-match-id="${matchId}"
                        aria-controls="${timelineId}"
                        aria-expanded="false"
                      >
                        <span>Build Timeline</span>
                        <span class="match-timeline-chevron transition-transform duration-200" aria-hidden="true">&#x25BC;</span>
                      </button>
                      <button
                        type="button"
                        class="match-pin-toggle flex-[1] inline-flex items-center justify-center rounded-md border px-3 py-2 text-xs ${pinClass} transition-colors"
                        aria-pressed="${isPinned ? 'true' : 'false'}"
                        title="${pinLabel} match"
                        data-match-id="${matchId}"
                      >
                        <i class="fas fa-thumbtack mr-1" aria-hidden="true"></i>
                        <span class="hidden sm:inline">${pinLabel}</span>
                      </button>
                      <button
                        type="button"
                        class="match-share-toggle flex-[1] inline-flex items-center justify-center rounded-md border border-cyan-500/20 bg-slate-800/40 px-3 py-2 text-xs text-cyan-300 hover:text-cyan-200 hover:border-cyan-400/40 transition-colors"
                        aria-label="Share match"
                        title="Share match"
                        data-match-id="${matchId}"
                        data-gamertag="${gamertag}"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <circle cx="18" cy="5" r="3"></circle>
                          <circle cx="6" cy="12" r="3"></circle>
                          <circle cx="18" cy="19" r="3"></circle>
                          <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                          <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                        </svg>
                        <span class="hidden sm:inline">Share</span>
                      </button>
                    </div>
                    <div id="${detailsId}" class="match-details mt-3 hidden" data-loaded="false"></div>
                    <div id="${timelineId}" class="match-timeline mt-3 hidden" data-loaded="false"></div>
                  ` : ''}
                </div>
              </div>
            </div>
        `;
      }).join('') + '</div>';
      matchesContent.classList.remove('hidden');
      matchesContent.querySelectorAll('img[data-fallback]').forEach((node) => {
        const img = node as HTMLImageElement;
        img.addEventListener('error', () => {
          const fallback = img.getAttribute('data-fallback') || '';
          if (fallback && img.getAttribute('src') !== fallback) {
            img.setAttribute('src', fallback);
          }
        }, { once: true });
      });

      const fetchMatchEventsPayload = async (matchId: string) => {
        const cached = matchEventsCache.get(matchId);
        if (cached) {
          return { ok: true, data: cached } as const;
        }
        const result = await getMatchEvents(matchId);
        if (result.ok) {
          matchEventsCache.set(matchId, result.data);
        }
        return result;
      };

      const buildEventEntries = async (payload: any) => {
        const eventsRaw = payload?.GameEvents;
        const events = Array.isArray(eventsRaw) ? eventsRaw : [];
        const isCompleteSet = payload?.IsCompleteSetOfEvents;

        const playersByIndex = new Map<number, PlayerInfo>();
        events.forEach((event: any) => {
          if (event?.EventName !== 'PlayerJoinedMatch') return;
          const index = event?.PlayerIndex;
          if (typeof index !== 'number') return;
          const humanId = event?.HumanPlayerId;
          const name =
            (typeof humanId === 'string' && humanId) ||
            (typeof humanId === 'object' && humanId?.Gamertag) ||
            (event?.PlayerType === 2 && event?.ComputerPlayerId != null ? `AI ${event.ComputerPlayerId}` : '') ||
            (event?.PlayerType === 3 ? 'NPC' : '') ||
            'Unknown';
          const teamId = typeof event?.TeamId === 'number' ? event.TeamId : null;
          const playerType = typeof event?.PlayerType === 'number' ? event.PlayerType : null;
          playersByIndex.set(index, { name, teamId, playerType });
        });

        const [leaderPowerMap, gameObjectMap, techMap] = await Promise.all([
          ensureLeaderPowerMap(),
          ensureGameObjectMap(),
          ensureTechMap(),
        ]);

        const buildingInstanceMap = new Map<number, string>();
        const entries: TimelineEntry[] = [];
        const resolveBuildingInstanceName = (instanceId?: number) => {
          if (typeof instanceId !== 'number') return '';
          const buildingId = buildingInstanceMap.get(instanceId);
          if (!buildingId) return `Instance ${instanceId}`;
          const buildingName = getGameObjectDisplayName(buildingId, gameObjectMap);
          return buildingName ? `${buildingName} (Instance ${instanceId})` : `Instance ${instanceId}`;
        };

        events.forEach((event: any) => {
          const instanceId = event?.InstanceId;
          if (typeof instanceId === 'number') {
            if (event?.EventName === 'BuildingConstructionQueued' && event?.BuildingId) {
              buildingInstanceMap.set(instanceId, String(event.BuildingId));
            }
          }

          const timeMs = event?.TimeSinceStartMilliseconds;
          if (typeof timeMs !== 'number') return;
          const playerIndex = typeof event?.PlayerIndex === 'number' ? event.PlayerIndex : null;
          const playerInfo = playerIndex != null ? playersByIndex.get(playerIndex) : null;
          const playerName = playerInfo?.name || (playerIndex != null ? `Player ${playerIndex}` : 'Unknown');
          const teamId = playerInfo?.teamId ?? null;

          if (event?.EventName === 'BuildingConstructionCompleted') {
            const buildingId = buildingInstanceMap.get(event?.InstanceId) || event?.BuildingId;
            const buildingName = buildingId ? getGameObjectDisplayName(String(buildingId), gameObjectMap) : 'Unknown Building';
            const detail = buildingId ? `ID: ${buildingId}` : (event?.InstanceId != null ? `Instance ${event.InstanceId}` : '');
            entries.push({
              timeMs,
              playerIndex,
              playerName,
              teamId,
              label: `Completed ${buildingName}`,
              kind: 'building',
              detail: detail || undefined,
            });
          }

          if (event?.EventName === 'BuildingUpgraded') {
            const currentId = typeof instanceId === 'number' ? buildingInstanceMap.get(instanceId) : undefined;
            const nextId = event?.NewBuildingId ? String(event.NewBuildingId) : '';
            const fromName = currentId ? getGameObjectDisplayName(currentId, gameObjectMap) : '';
            const toName = nextId ? getGameObjectDisplayName(nextId, gameObjectMap) : 'Unknown Building';
            const label = fromName ? `Upgraded ${fromName} -> ${toName}` : `Upgraded to ${toName}`;
            const detail = nextId ? `ID: ${nextId}` : (event?.InstanceId != null ? `Instance ${event.InstanceId}` : '');
            entries.push({
              timeMs,
              playerIndex,
              playerName,
              teamId,
              label,
              kind: 'upgrade',
              detail: detail || undefined,
            });
            if (typeof instanceId === 'number' && nextId) {
              buildingInstanceMap.set(instanceId, nextId);
            }
          }

          if (event?.EventName === 'UnitTrained') {
            const squadId = event?.SquadId;
            const unitName = squadId ? getGameObjectDisplayName(String(squadId), gameObjectMap) : 'Unknown Unit';
            const detailBits = [];
            if (event?.IsClone) detailBits.push('Clone');
            if (event?.ProvidedByScenario) detailBits.push('Scenario');
            if (event?.CreatorInstanceId) {
              const source = resolveBuildingInstanceName(event.CreatorInstanceId);
              detailBits.push(`From ${source || `Instance ${event.CreatorInstanceId}`}`);
            }
            entries.push({
              timeMs,
              playerIndex,
              playerName,
              teamId,
              label: `Trained ${unitName}`,
              kind: 'unit',
              detail: detailBits.length ? detailBits.join(' | ') : undefined,
            });
          }

          if (event?.EventName === 'UnitPromoted') {
            const squadId = event?.SquadId;
            const unitName = squadId ? getGameObjectDisplayName(String(squadId), gameObjectMap) : 'Unknown Unit';
            const detail = event?.InstanceId != null ? `Instance ${event.InstanceId}` : '';
            entries.push({
              timeMs,
              playerIndex,
              playerName,
              teamId,
              label: `Veterancy: ${unitName}`,
              kind: 'veterancy',
              detail: detail || undefined,
            });
          }

          if (event?.EventName === 'TechResearched') {
            const techId = event?.TechId;
            const techName = techId ? getTechDisplayName(String(techId), techMap) : 'Unknown Tech';
            const detailBits = [];
            if (event?.SupplyCost) detailBits.push(`Supply ${event.SupplyCost}`);
            if (event?.EnergyCost) detailBits.push(`Energy ${event.EnergyCost}`);
            if (event?.ResearcherInstanceId) {
              const source = resolveBuildingInstanceName(event.ResearcherInstanceId);
              detailBits.push(`From ${source || `Instance ${event.ResearcherInstanceId}`}`);
            }
            if (event?.ProvidedByScenario) detailBits.push('Scenario');
            entries.push({
              timeMs,
              playerIndex,
              playerName,
              teamId,
              label: `Researched ${techName}`,
              kind: 'unit_upgrade',
              detail: detailBits.length ? detailBits.join(' | ') : undefined,
            });
          }

          if (event?.EventName === 'LeaderPowerCast') {
            const powerId = event?.PowerId;
            const powerName = powerId ? getLeaderPowerDisplayName(String(powerId), leaderPowerMap) : 'Unknown Power';
            entries.push({
              timeMs,
              playerIndex,
              playerName,
              teamId,
              label: `Cast ${powerName}`,
              kind: 'power',
            });
          }
        });

        return { entries, playersByIndex, isCompleteSet };
      };

      const buildEventSummarySections = (entries: TimelineEntry[], playersByIndex: Map<number, PlayerInfo>) => {
        const playerCounts = new Map<number, { playerIndex: number; name: string; teamId: number | null; units: number; techs: number; powers: number }>();
        const buildOrderEntries = new Map<number, { playerIndex: number; name: string; teamId: number | null; entries: TimelineEntry[] }>();
        const buildOrderKinds = new Set<TimelineEntry['kind']>(['building', 'unit', 'upgrade', 'unit_upgrade']);

        entries.forEach((entry) => {
          if (entry.playerIndex == null) return;
          const playerInfo = playersByIndex.get(entry.playerIndex);
          const name = playerInfo?.name || entry.playerName || `Player ${entry.playerIndex}`;
          const teamId = playerInfo?.teamId ?? entry.teamId ?? null;
          const row = playerCounts.get(entry.playerIndex) || {
            playerIndex: entry.playerIndex,
            name,
            teamId,
            units: 0,
            techs: 0,
            powers: 0,
          };
          if (entry.kind === 'unit') row.units += 1;
          if (entry.kind === 'unit_upgrade') row.techs += 1;
          if (entry.kind === 'power') row.powers += 1;
          playerCounts.set(entry.playerIndex, row);

          if (buildOrderKinds.has(entry.kind)) {
            const orderRow = buildOrderEntries.get(entry.playerIndex) || {
              playerIndex: entry.playerIndex,
              name,
              teamId,
              entries: [],
            };
            orderRow.entries.push(entry);
            buildOrderEntries.set(entry.playerIndex, orderRow);
          }
        });

        playersByIndex.forEach((info, index) => {
          if (info.playerType === 3) return;
          if (!playerCounts.has(index)) {
            playerCounts.set(index, {
              playerIndex: index,
              name: info.name || `Player ${index}`,
              teamId: info.teamId ?? null,
              units: 0,
              techs: 0,
              powers: 0,
            });
          }
        });

        const summaryTeams = new Map<number, { players: Array<{ playerIndex: number; name: string; units: number; techs: number; powers: number }>; totals: { units: number; techs: number; powers: number } }>();
        playerCounts.forEach((row) => {
          const teamKey = typeof row.teamId === 'number' ? row.teamId : -1;
          const team = summaryTeams.get(teamKey) || { players: [], totals: { units: 0, techs: 0, powers: 0 } };
          team.players.push({ playerIndex: row.playerIndex, name: row.name, units: row.units, techs: row.techs, powers: row.powers });
          team.totals.units += row.units;
          team.totals.techs += row.techs;
          team.totals.powers += row.powers;
          summaryTeams.set(teamKey, team);
        });

        const summaryCards = [...summaryTeams.entries()]
          .sort((a, b) => a[0] - b[0])
          .map(([teamId, team]) => {
            const headerLabel = teamId === -1 ? 'Unknown Team' : (teamId === 0 ? 'Neutral' : `Team ${teamId}`);
            const rows = team.players
              .sort((a, b) => a.playerIndex - b.playerIndex)
              .map((player) => `
                <span class="text-gray-200 truncate">${player.name}</span>
                <span class="text-xs font-mono text-sky-200 text-right">${player.units}</span>
                <span class="text-xs font-mono text-teal-200 text-right">${player.techs}</span>
                <span class="text-xs font-mono text-amber-200 text-right">${player.powers}</span>
              `).join('');
            const tableHtml = team.players.length
              ? `
                <div class="grid grid-cols-[minmax(0,1fr)_auto_auto_auto] gap-3 text-xs">
                  <span class="text-[10px] uppercase tracking-wider text-gray-500">Player</span>
                  <span class="text-[10px] uppercase tracking-wider text-gray-500 text-right">Units</span>
                  <span class="text-[10px] uppercase tracking-wider text-gray-500 text-right">Unit Upgrades</span>
                  <span class="text-[10px] uppercase tracking-wider text-gray-500 text-right">Powers</span>
                  ${rows}
                </div>
              `
              : '<p class="text-xs text-gray-500">No player data.</p>';

            return `
              <div class="rounded-lg border border-slate-700/40 bg-slate-800/40 p-3">
                <div class="flex items-center justify-between mb-2">
                  <p class="text-[10px] uppercase tracking-wider text-gray-400">${headerLabel}</p>
                  <span class="text-[10px] uppercase tracking-wider text-gray-500">Totals</span>
                </div>
                ${tableHtml}
                <div class="mt-3 flex flex-wrap gap-3 text-[10px] uppercase tracking-wider text-gray-500">
                  <span>Units <span class="text-sky-200">${team.totals.units}</span></span>
                  <span>Unit Upgrades <span class="text-teal-200">${team.totals.techs}</span></span>
                  <span>Powers <span class="text-amber-200">${team.totals.powers}</span></span>
                </div>
              </div>
            `;
          });

        const buildOrderTeams = new Map<number, Array<{ playerIndex: number; name: string; entries: TimelineEntry[] }>>();
        buildOrderEntries.forEach((row) => {
          const teamKey = typeof row.teamId === 'number' ? row.teamId : -1;
          const list = buildOrderTeams.get(teamKey) || [];
          const entriesSorted = row.entries.sort((a, b) => a.timeMs - b.timeMs).slice(0, 5);
          list.push({ playerIndex: row.playerIndex, name: row.name, entries: entriesSorted });
          buildOrderTeams.set(teamKey, list);
        });

        const buildOrderCards = [...buildOrderTeams.entries()]
          .sort((a, b) => a[0] - b[0])
          .map(([teamId, players]) => {
            const headerLabel = teamId === -1 ? 'Unknown Team' : (teamId === 0 ? 'Neutral' : `Team ${teamId}`);
            const playerBlocks = players
              .sort((a, b) => a.playerIndex - b.playerIndex)
              .map((player) => {
                const items = player.entries.map((entry) => `
                  <div class="grid grid-cols-[52px_minmax(0,1fr)] gap-2 text-xs">
                    <span class="font-mono text-cyan-300">${formatMatchClock(entry.timeMs)}</span>
                    <span class="text-gray-300">${entry.label}</span>
                  </div>
                `).join('') || '<span class="text-xs text-gray-500">No build order data</span>';
                return `
                  <div class="rounded-md border border-slate-700/40 bg-slate-900/40 p-2">
                    <p class="text-[10px] uppercase tracking-wider text-gray-400 mb-2">${player.name}</p>
                    <div class="space-y-1">
                      ${items}
                    </div>
                  </div>
                `;
              }).join('');

            return `
              <div class="rounded-lg border border-slate-700/40 bg-slate-800/40 p-3">
                <div class="flex items-center justify-between mb-2">
                  <p class="text-[10px] uppercase tracking-wider text-gray-400">${headerLabel}</p>
                  <span class="text-[10px] uppercase tracking-wider text-gray-500">First 5</span>
                </div>
                <div class="space-y-2">
                  ${playerBlocks}
                </div>
              </div>
            `;
          });

        return {
          summaryCards,
          buildOrderCards,
        };
      };

      const getSummarySkeleton = () => `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div class="rounded-lg border border-slate-700/40 bg-slate-800/40 p-3 animate-pulse">
            <div class="h-3 w-24 bg-slate-700/60 rounded mb-3"></div>
            <div class="space-y-2">
              <div class="h-3 bg-slate-700/50 rounded"></div>
              <div class="h-3 bg-slate-700/50 rounded w-5/6"></div>
              <div class="h-3 bg-slate-700/50 rounded w-4/6"></div>
            </div>
          </div>
          <div class="rounded-lg border border-slate-700/40 bg-slate-800/40 p-3 animate-pulse">
            <div class="h-3 w-28 bg-slate-700/60 rounded mb-3"></div>
            <div class="space-y-2">
              <div class="h-3 bg-slate-700/50 rounded"></div>
              <div class="h-3 bg-slate-700/50 rounded w-5/6"></div>
              <div class="h-3 bg-slate-700/50 rounded w-4/6"></div>
            </div>
          </div>
        </div>
        <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div class="rounded-lg border border-slate-700/40 bg-slate-800/40 p-3 animate-pulse">
            <div class="h-3 w-32 bg-slate-700/60 rounded mb-3"></div>
            <div class="space-y-2">
              <div class="h-3 bg-slate-700/50 rounded"></div>
              <div class="h-3 bg-slate-700/50 rounded w-5/6"></div>
              <div class="h-3 bg-slate-700/50 rounded w-4/6"></div>
            </div>
          </div>
          <div class="rounded-lg border border-slate-700/40 bg-slate-800/40 p-3 animate-pulse">
            <div class="h-3 w-28 bg-slate-700/60 rounded mb-3"></div>
            <div class="space-y-2">
              <div class="h-3 bg-slate-700/50 rounded"></div>
              <div class="h-3 bg-slate-700/50 rounded w-5/6"></div>
              <div class="h-3 bg-slate-700/50 rounded w-4/6"></div>
            </div>
          </div>
        </div>
      `;

      const loadMatchSummary = async (matchId: string, summaryContentEl: HTMLElement, options: { reveal?: boolean } = {}) => {
        if (summaryContentEl.getAttribute('data-loading') === 'true') return;
        summaryContentEl.setAttribute('data-loading', 'true');
        if (options.reveal) {
          summaryContentEl.classList.remove('hidden');
        }
        summaryContentEl.innerHTML = getSummarySkeleton();

        const eventResult = await fetchMatchEventsPayload(matchId);
        if (!eventResult.ok) {
          summaryContentEl.removeAttribute('data-loading');
          summaryContentEl.innerHTML = `
            <div class="rounded-lg border border-slate-700/40 bg-slate-900/40 p-3 text-sm text-gray-400">
              Match summary unavailable.
              <button type="button" class="match-summary-retry ml-2 text-xs text-cyan-300 hover:text-cyan-200 underline" data-match-id="${matchId}">Retry</button>
            </div>
          `;
          const retryBtn = summaryContentEl.querySelector('.match-summary-retry') as HTMLButtonElement | null;
          if (retryBtn) {
            retryBtn.addEventListener('click', () => {
              summaryContentEl.setAttribute('data-loaded', 'false');
              loadMatchSummary(matchId, summaryContentEl, { reveal: true });
            });
          }
          return;
        }

        const { entries, playersByIndex, isCompleteSet } = await buildEventEntries(eventResult.data);
        if (entries.length === 0) {
          summaryContentEl.removeAttribute('data-loading');
          summaryContentEl.innerHTML = `
            <div class="rounded-lg border border-slate-700/40 bg-slate-900/40 p-3 text-sm text-gray-400">
              No event data available for this match.
              <button type="button" class="match-summary-retry ml-2 text-xs text-cyan-300 hover:text-cyan-200 underline" data-match-id="${matchId}">Retry</button>
            </div>
          `;
          const retryBtn = summaryContentEl.querySelector('.match-summary-retry') as HTMLButtonElement | null;
          if (retryBtn) {
            retryBtn.addEventListener('click', () => {
              summaryContentEl.setAttribute('data-loaded', 'false');
              loadMatchSummary(matchId, summaryContentEl, { reveal: true });
            });
          }
          return;
        }

        const { summaryCards, buildOrderCards } = buildEventSummarySections(entries, playersByIndex);
        const completionTag = isCompleteSet === false
          ? '<span class="text-amber-300">Event feed incomplete</span>'
          : '<span class="text-emerald-300">Event feed complete</span>';
        summaryContentEl.innerHTML = `
          <div class="flex flex-wrap items-center justify-between gap-2 text-[11px] uppercase tracking-wider text-gray-500 mb-2">
            <span>Match Summary</span>
            ${completionTag}
          </div>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            ${summaryCards.join('')}
          </div>
          <div class="mt-4">
            <div class="flex flex-wrap items-center justify-between gap-2 text-[11px] uppercase tracking-wider text-gray-500 mb-2">
              <span>Build Order Highlights</span>
              <span class="text-[10px] uppercase tracking-wider text-gray-500">First 5</span>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
              ${buildOrderCards.join('')}
            </div>
          </div>
        `;
        summaryContentEl.removeAttribute('data-loading');
        summaryContentEl.setAttribute('data-loaded', 'true');
      };

      const loadMatchDetails = async (matchId: string, detailsEl: HTMLElement) => {
        if (detailsEl.getAttribute('data-loading') === 'true') return;
        detailsEl.setAttribute('data-loading', 'true');
        detailsEl.innerHTML = 'Loading team compositions...';

        const result = await getMatchResult(matchId);
        detailsEl.removeAttribute('data-loading');

        if (!result.ok) {
          const message = result.error?.message || 'Unable to load team compositions.';
          detailsEl.innerHTML = `
            <div class="flex items-center gap-3 text-red-300">
              <span>${message}</span>
              <button type="button" class="match-details-retry text-xs text-cyan-300 hover:text-cyan-200 underline" data-match-id="${matchId}">Retry</button>
            </div>
          `;
          const retryBtn = detailsEl.querySelector('.match-details-retry') as HTMLButtonElement | null;
          if (retryBtn) {
            retryBtn.addEventListener('click', () => loadMatchDetails(matchId, detailsEl));
          }
          return;
        }

        const playersRaw = result.data?.Players;
        const players = Array.isArray(playersRaw)
          ? playersRaw
          : (playersRaw && typeof playersRaw === 'object')
            ? Object.values(playersRaw)
            : [];

        const leaderPowerMap = await ensureLeaderPowerMap();
        const teamMap = new Map<number, { members: Array<{ name: string; leader: string; destroyed: number; lost: number; powerEntries: Array<{ name: string; times: number }> }>; totals: { destroyed: number; lost: number; powers: number } }>();
        players.forEach((p: any) => {
          const teamId = p.TeamId;
          const leaderId = p.LeaderId;
          if (teamId == null || leaderId == null) return;
          const gamertag = p?.HumanPlayerId?.Gamertag
            || p?.Gamertag
            || (p?.HumanPlayerId && typeof p.HumanPlayerId === 'string' ? p.HumanPlayerId : '')
            || (p?.IsHuman === false ? 'AI' : '')
            || (p?.ComputerPlayerId != null ? `AI ${p.ComputerPlayerId}` : '')
            || 'Unknown';
          const leaderName = getLeaderName(leaderId);
          let destroyed = 0;
          let lost = 0;
          const unitStats = p?.UnitStats;
          if (unitStats && typeof unitStats === 'object') {
            Object.values(unitStats).forEach((u: any) => {
              destroyed += u?.TotalDestroyed || 0;
              lost += u?.TotalLost || 0;
            });
          }
          const powerEntries: Array<{ name: string; times: number }> = [];
          let powerCount = 0;
          const leaderPowerStats = p?.LeaderPowerStats;
          if (leaderPowerStats && typeof leaderPowerStats === 'object') {
            const entries = Object.entries(leaderPowerStats)
              .map(([powerId, stats]) => {
                const times = typeof stats === 'number'
                  ? stats
                  : (stats as any)?.TimesCast ?? (stats as any)?.TotalPlays ?? 0;
                return { powerId, times };
              })
              .filter((pwr) => pwr.times > 0)
              .sort((a, b) => b.times - a.times);
            entries.forEach((pwr) => {
              powerEntries.push({ name: getLeaderPowerDisplayName(pwr.powerId, leaderPowerMap), times: pwr.times });
              powerCount += pwr.times;
            });
          }
          const team = teamMap.get(teamId) || { members: [], totals: { destroyed: 0, lost: 0, powers: 0 } };
          team.members.push({ name: gamertag, leader: leaderName, destroyed, lost, powerEntries });
          team.totals.destroyed += destroyed;
          team.totals.lost += lost;
          team.totals.powers += powerCount;
          teamMap.set(teamId, team);
        });

        if (teamMap.size === 0) {
          detailsEl.innerHTML = 'Team composition data not available.';
          return;
        }

        const teamCards = [...teamMap.entries()]
          .sort((a, b) => a[0] - b[0])
          .map(([teamId, team]) => {
            const rows = team.members.map((m) => `
              <span class="text-gray-200 truncate">${m.name}</span>
              <span class="text-cyan-300 truncate">${m.leader}</span>
              <span class="text-xs text-gray-400 text-right">${m.destroyed} / ${m.lost}</span>
            `).join('');
            const powerRows = team.members.map((m) => {
              const powerText = m.powerEntries.length
                ? m.powerEntries.map((pwr) => `${pwr.name} x${pwr.times}`).join(', ')
                : '-';
              return `
                <div class="grid grid-cols-[minmax(0,1fr)_minmax(0,2fr)] gap-3 text-xs">
                  <span class="text-gray-300 truncate">${m.name}</span>
                  <span class="text-gray-400">${powerText}</span>
                </div>
              `;
            }).join('');
            return `
              <div class="rounded-lg border border-slate-700/40 bg-slate-800/40 p-3">
                <p class="text-[10px] uppercase tracking-wider text-gray-400 mb-2">Team ${teamId}</p>
                <div class="grid grid-cols-[minmax(0,1fr)_minmax(0,1fr)_auto] gap-3 text-xs">
                  <span class="text-[10px] uppercase tracking-wider text-gray-500">Player</span>
                  <span class="text-[10px] uppercase tracking-wider text-gray-500">Leader</span>
                  <span class="text-[10px] uppercase tracking-wider text-gray-500 text-right">Units Destroyed / Units Lost</span>
                  ${rows}
                </div>
                <div class="mt-3 border-t border-slate-700/40 pt-3">
                  <p class="text-[10px] uppercase tracking-wider text-gray-500 mb-2">Leader Powers by Player</p>
                  <div class="space-y-2">
                    ${powerRows}
                  </div>
                </div>
                <div class="mt-3 border-t border-slate-700/40 pt-3 flex flex-wrap gap-4 text-[10px] uppercase tracking-wider text-gray-500">
                  <span>Units Destroyed: <span class="text-gray-300">${team.totals.destroyed}</span></span>
                  <span>Units Lost: <span class="text-gray-300">${team.totals.lost}</span></span>
                  <span>Leader Powers Used: <span class="text-gray-300">${team.totals.powers}</span></span>
                </div>
              </div>
            `;
          });

        detailsEl.innerHTML = `
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">${teamCards.join('')}</div>
          <div class="mt-4 rounded-lg border border-slate-700/40 bg-slate-900/40 p-3">
            <div>
              <p class="text-[11px] uppercase tracking-wider text-gray-400">Match Summary + Build Order</p>
              <p class="text-xs text-gray-500">Loads with event data for this match.</p>
            </div>
            <div id="match-summary-${matchId}" class="match-summary-content mt-3" data-loaded="false"></div>
          </div>
        `;

        const summaryContent = detailsEl.querySelector('.match-summary-content') as HTMLElement | null;
        if (summaryContent && summaryContent.getAttribute('data-loaded') !== 'true') {
          loadMatchSummary(matchId, summaryContent, { reveal: true });
        }
        detailsEl.setAttribute('data-loaded', 'true');
      };

      const loadMatchTimeline = async (matchId: string, timelineEl: HTMLElement) => {
        if (timelineEl.getAttribute('data-loading') === 'true') return;
        timelineEl.setAttribute('data-loading', 'true');
        timelineEl.innerHTML = 'Loading build timeline...';

        let payload = matchEventsCache.get(matchId);
        if (!payload) {
          const result = await getMatchEvents(matchId);
          if (!result.ok) {
            const message = result.error?.message || 'Unable to load match events.';
            timelineEl.removeAttribute('data-loading');
            timelineEl.innerHTML = `
              <div class="flex items-center gap-3 text-red-300">
                <span>${message}</span>
                <button type="button" class="match-timeline-retry text-xs text-cyan-300 hover:text-cyan-200 underline" data-match-id="${matchId}">Retry</button>
              </div>
            `;
            const retryBtn = timelineEl.querySelector('.match-timeline-retry') as HTMLButtonElement | null;
            if (retryBtn) {
              retryBtn.addEventListener('click', () => loadMatchTimeline(matchId, timelineEl));
            }
            return;
          }
          payload = result.data;
          matchEventsCache.set(matchId, payload);
        }

        const { entries, playersByIndex, isCompleteSet } = await buildEventEntries(payload);
        if (entries.length === 0) {
          timelineEl.removeAttribute('data-loading');
          timelineEl.innerHTML = `
            <div class="text-sm text-gray-400">
              No event data available for this match.
              <button type="button" class="match-timeline-retry ml-2 text-xs text-cyan-300 hover:text-cyan-200 underline" data-match-id="${matchId}">Retry</button>
            </div>
          `;
          const retryBtn = timelineEl.querySelector('.match-timeline-retry') as HTMLButtonElement | null;
          if (retryBtn) {
            retryBtn.addEventListener('click', () => loadMatchTimeline(matchId, timelineEl));
          }
          timelineEl.setAttribute('data-loaded', 'true');
          return;
        }

        const completionTag = isCompleteSet === false
          ? '<span class="text-amber-300">Event feed incomplete</span>'
          : '<span class="text-emerald-300">Event feed complete</span>';

        const maxTimeMs = entries.reduce((max, entry) => Math.max(max, entry.timeMs), 0);
        const maxMinutes = Math.max(1, Math.ceil(maxTimeMs / 60000));
        const playerOptions = [...playersByIndex.entries()]
          .filter(([, info]) => info.playerType !== 3)
          .sort((a, b) => a[0] - b[0])
          .map(([index, info]) => {
            const teamLabel = typeof info.teamId === 'number' ? `Team ${info.teamId}` : 'Team ?';
            return `<option value="${index}">${info.name} (${teamLabel})</option>`;
          })
          .join('');

        timelineEl.innerHTML = `
          <div class="flex flex-wrap items-center justify-between gap-2 text-[11px] uppercase tracking-wider text-gray-500 mb-3">
            <span>Build timeline by team</span>
            <span class="flex items-center gap-3">
              <span data-timeline-count="${matchId}">0 events</span>
              ${completionTag}
            </span>
          </div>
          <div class="rounded-lg border border-slate-700/40 bg-slate-800/30 p-3 mb-3">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-xs">
              <label class="flex flex-col gap-1">
                <span class="text-[10px] uppercase tracking-wider text-gray-400">Player</span>
                <select class="timeline-player-filter w-full rounded-md border border-slate-700/60 bg-slate-900/60 px-2 py-1 text-gray-200">
                  <option value="all">All players</option>
                  ${playerOptions}
                </select>
              </label>
              <div>
                <span class="block text-[10px] uppercase tracking-wider text-gray-400 mb-1">Event types</span>
                <div class="flex flex-wrap gap-2">
                  <label class="inline-flex items-center gap-2 rounded-full border border-emerald-400/30 bg-emerald-400/10 px-3 py-1">
                    <input type="checkbox" name="timeline-type" value="building" checked class="accent-emerald-400" />
                    <span class="text-[10px] uppercase tracking-wider text-emerald-200">Buildings</span>
                  </label>
                  <label class="inline-flex items-center gap-2 rounded-full border border-orange-400/30 bg-orange-400/10 px-3 py-1">
                    <input type="checkbox" name="timeline-type" value="upgrade" checked class="accent-orange-400" />
                    <span class="text-[10px] uppercase tracking-wider text-orange-200">Building Upgrades</span>
                  </label>
                  <label class="inline-flex items-center gap-2 rounded-full border border-sky-400/30 bg-sky-400/10 px-3 py-1">
                    <input type="checkbox" name="timeline-type" value="unit" checked class="accent-sky-400" />
                    <span class="text-[10px] uppercase tracking-wider text-sky-200">Units</span>
                  </label>
                  <label class="inline-flex items-center gap-2 rounded-full border border-teal-400/30 bg-teal-400/10 px-3 py-1">
                    <input type="checkbox" name="timeline-type" value="unit_upgrade" checked class="accent-teal-400" />
                    <span class="text-[10px] uppercase tracking-wider text-teal-200">Unit Upgrades</span>
                  </label>
                  <label class="inline-flex items-center gap-2 rounded-full border border-rose-400/30 bg-rose-400/10 px-3 py-1">
                    <input type="checkbox" name="timeline-type" value="veterancy" checked class="accent-rose-400" />
                    <span class="text-[10px] uppercase tracking-wider text-rose-200">Veterancy</span>
                  </label>
                  <label class="inline-flex items-center gap-2 rounded-full border border-amber-400/30 bg-amber-400/10 px-3 py-1">
                    <input type="checkbox" name="timeline-type" value="power" checked class="accent-amber-400" />
                    <span class="text-[10px] uppercase tracking-wider text-amber-200">Powers</span>
                  </label>
                </div>
              </div>
              <label class="flex flex-col gap-1">
                <span class="text-[10px] uppercase tracking-wider text-gray-400">Start (min)</span>
                <input type="number" min="0" max="${maxMinutes}" step="1" value="0" class="timeline-start w-full rounded-md border border-slate-700/60 bg-slate-900/60 px-2 py-1 text-gray-200" />
              </label>
              <label class="flex flex-col gap-1">
                <span class="text-[10px] uppercase tracking-wider text-gray-400">End (min)</span>
                <input type="number" min="0" max="${maxMinutes}" step="1" value="${maxMinutes}" class="timeline-end w-full rounded-md border border-slate-700/60 bg-slate-900/60 px-2 py-1 text-gray-200" />
                <span class="text-[10px] text-gray-500">Max ${formatMatchClock(maxTimeMs)}</span>
              </label>
            </div>
          </div>
          <div class="match-timeline-list grid grid-cols-1 lg:grid-cols-2 gap-4"></div>
        `;

        const listEl = timelineEl.querySelector('.match-timeline-list') as HTMLElement | null;
        const playerFilter = timelineEl.querySelector('.timeline-player-filter') as HTMLSelectElement | null;
        const typeInputs = Array.from(timelineEl.querySelectorAll('input[name="timeline-type"]')) as HTMLInputElement[];
        const startInput = timelineEl.querySelector('.timeline-start') as HTMLInputElement | null;
        const endInput = timelineEl.querySelector('.timeline-end') as HTMLInputElement | null;
        const countEl = timelineEl.querySelector(`[data-timeline-count="${matchId}"]`) as HTMLElement | null;

          const filterState = {
          player: 'all',
          types: new Set(['building', 'upgrade', 'unit', 'unit_upgrade', 'power', 'veterancy']),
          startMin: 0,
          endMin: maxMinutes,
        };

        const resolveTag = (kind: TimelineEntry['kind']) => {
          switch (kind) {
            case 'building':
              return { className: 'border-emerald-400/40 text-emerald-200 bg-emerald-400/10', label: 'Building' };
            case 'upgrade':
              return { className: 'border-orange-400/40 text-orange-200 bg-orange-400/10', label: 'Building Upgrade' };
            case 'unit':
              return { className: 'border-sky-400/40 text-sky-200 bg-sky-400/10', label: 'Unit' };
            case 'unit_upgrade':
              return { className: 'border-teal-400/40 text-teal-200 bg-teal-400/10', label: 'Unit Upgrade' };
            case 'veterancy':
              return { className: 'border-rose-400/40 text-rose-200 bg-rose-400/10', label: 'Veterancy' };
            default:
              return { className: 'border-amber-400/40 text-amber-200 bg-amber-400/10', label: 'Power' };
          }
        };

        const renderTimelineList = () => {
          if (!listEl) return;
          const startMs = Math.max(0, filterState.startMin) * 60000;
          const endMs = Math.max(0, filterState.endMin) * 60000;
          const filtered = entries.filter((entry) => {
            if (filterState.player !== 'all' && String(entry.playerIndex) !== filterState.player) return false;
            if (!filterState.types.has(entry.kind)) return false;
            if (entry.timeMs < startMs || entry.timeMs > endMs) return false;
            return true;
          });

          if (countEl) {
            countEl.textContent = `${filtered.length} events`;
          }

          if (filtered.length === 0) {
            listEl.innerHTML = '<div class="text-sm text-gray-400">No events in this filter window.</div>';
            return;
          }

          const teamGroups = new Map<number, TimelineEntry[]>();
          const unassigned: TimelineEntry[] = [];

          filtered.forEach((entry) => {
            if (typeof entry.teamId === 'number') {
              const group = teamGroups.get(entry.teamId) || [];
              group.push(entry);
              teamGroups.set(entry.teamId, group);
            } else {
              unassigned.push(entry);
            }
          });

          teamGroups.forEach((group) => group.sort((a, b) => a.timeMs - b.timeMs));
          unassigned.sort((a, b) => a.timeMs - b.timeMs);

          const teamCards = [...teamGroups.entries()]
            .sort((a, b) => a[0] - b[0])
            .map(([teamId, group]) => {
              const headerLabel = teamId === 0 ? 'Neutral' : `Team ${teamId}`;
              const counts = { building: 0, unit: 0, power: 0 };
              group.forEach((entry) => {
                if (entry.kind === 'building') counts.building += 1;
                if (entry.kind === 'unit') counts.unit += 1;
                if (entry.kind === 'power') counts.power += 1;
              });
              const rows = group.map((entry) => {
                const timeLabel = formatMatchClock(entry.timeMs);
                const tag = resolveTag(entry.kind);
                return `
                  <div class="grid grid-cols-[72px_minmax(0,1fr)] gap-3 items-start text-xs">
                    <span class="font-mono text-cyan-300">${timeLabel}</span>
                    <div>
                      <div class="flex flex-wrap items-center gap-2">
                        <span class="text-gray-200 truncate">${entry.playerName}</span>
                        <span class="inline-flex items-center px-2 py-0.5 rounded-full border text-[10px] uppercase tracking-wider ${tag.className}">${tag.label}</span>
                        <span class="text-gray-300">${entry.label}</span>
                      </div>
                      ${entry.detail ? `<div class="text-[10px] text-gray-500 mt-1">${entry.detail}</div>` : ''}
                    </div>
                  </div>
                `;
              }).join('');

              return `
                <div class="rounded-lg border border-slate-700/40 bg-slate-800/40 p-3">
                  <div class="flex items-center justify-between mb-2">
                    <p class="text-[10px] uppercase tracking-wider text-gray-400">${headerLabel}</p>
                    <span class="text-[10px] uppercase tracking-wider text-gray-500">${group.length} events</span>
                  </div>
                  <div class="flex flex-wrap gap-3 text-[10px] uppercase tracking-wider text-gray-500 mb-3">
                    <span>Buildings <span class="text-emerald-200">${counts.building}</span></span>
                    <span>Units <span class="text-sky-200">${counts.unit}</span></span>
                    <span>Powers <span class="text-amber-200">${counts.power}</span></span>
                  </div>
                  <div class="space-y-3">
                    ${rows}
                  </div>
                </div>
              `;
            });

          if (unassigned.length > 0) {
            const counts = { building: 0, unit: 0, power: 0 };
            unassigned.forEach((entry) => {
              if (entry.kind === 'building') counts.building += 1;
              if (entry.kind === 'unit') counts.unit += 1;
              if (entry.kind === 'power') counts.power += 1;
            });
            const rows = unassigned.map((entry) => {
              const timeLabel = formatMatchClock(entry.timeMs);
              const tag = resolveTag(entry.kind);
              return `
                <div class="grid grid-cols-[72px_minmax(0,1fr)] gap-3 items-start text-xs">
                  <span class="font-mono text-cyan-300">${timeLabel}</span>
                  <div>
                    <div class="flex flex-wrap items-center gap-2">
                      <span class="text-gray-200 truncate">${entry.playerName}</span>
                      <span class="inline-flex items-center px-2 py-0.5 rounded-full border text-[10px] uppercase tracking-wider ${tag.className}">${tag.label}</span>
                      <span class="text-gray-300">${entry.label}</span>
                    </div>
                    ${entry.detail ? `<div class="text-[10px] text-gray-500 mt-1">${entry.detail}</div>` : ''}
                  </div>
                </div>
              `;
            }).join('');

            teamCards.push(`
              <div class="rounded-lg border border-slate-700/40 bg-slate-800/40 p-3">
                <div class="flex items-center justify-between mb-2">
                  <p class="text-[10px] uppercase tracking-wider text-gray-400">Unknown Team</p>
                  <span class="text-[10px] uppercase tracking-wider text-gray-500">${unassigned.length} events</span>
                </div>
                <div class="flex flex-wrap gap-3 text-[10px] uppercase tracking-wider text-gray-500 mb-3">
                  <span>Buildings <span class="text-emerald-200">${counts.building}</span></span>
                  <span>Units <span class="text-sky-200">${counts.unit}</span></span>
                  <span>Powers <span class="text-amber-200">${counts.power}</span></span>
                </div>
                <div class="space-y-3">
                  ${rows}
                </div>
              </div>
            `);
          }

          listEl.innerHTML = teamCards.join('');
        };

        const updateFilter = () => {
          if (playerFilter) {
            filterState.player = playerFilter.value;
          }
          const selected = new Set<string>();
          typeInputs.forEach((input) => {
            if (input.checked) selected.add(input.value);
          });
          filterState.types = selected;
          if (startInput) {
            const value = Number(startInput.value);
            filterState.startMin = Number.isFinite(value) ? Math.max(0, value) : 0;
          }
          if (endInput) {
            const value = Number(endInput.value);
            filterState.endMin = Number.isFinite(value) ? Math.max(0, value) : maxMinutes;
          }
          if (filterState.startMin > filterState.endMin) {
            filterState.endMin = filterState.startMin;
            if (endInput) endInput.value = String(filterState.endMin);
          }
          renderTimelineList();
        };

        if (playerFilter) playerFilter.addEventListener('change', updateFilter);
        typeInputs.forEach((input) => input.addEventListener('change', updateFilter));
        if (startInput) startInput.addEventListener('change', updateFilter);
        if (endInput) endInput.addEventListener('change', updateFilter);
        renderTimelineList();

        timelineEl.removeAttribute('data-loading');
        timelineEl.setAttribute('data-loaded', 'true');
      };

      matchesContent.querySelectorAll('.match-details-toggle').forEach(btn => {
        btn.addEventListener('click', async () => {
          const matchId = (btn as HTMLElement).getAttribute('data-match-id') || '';
          if (!matchId) return;
          const detailsId = `match-details-${matchId}`;
          const detailsEl = document.getElementById(detailsId);
          const chevron = (btn as HTMLElement).querySelector('.match-details-chevron') as HTMLElement | null;
          if (!detailsEl) return;

          const isExpanded = (btn as HTMLElement).getAttribute('aria-expanded') === 'true';
          (btn as HTMLElement).setAttribute('aria-expanded', isExpanded ? 'false' : 'true');
          detailsEl.classList.toggle('hidden', isExpanded);
          if (chevron) chevron.style.transform = isExpanded ? 'rotate(0deg)' : 'rotate(180deg)';
          if (isExpanded) return;

          if (detailsEl.getAttribute('data-loaded') === 'true') return;
          await loadMatchDetails(matchId, detailsEl);
        });
      });

      matchesContent.querySelectorAll('.match-timeline-toggle').forEach(btn => {
        btn.addEventListener('click', async () => {
          const matchId = (btn as HTMLElement).getAttribute('data-match-id') || '';
          if (!matchId) return;
          const timelineId = `match-timeline-${matchId}`;
          const timelineEl = document.getElementById(timelineId);
          const chevron = (btn as HTMLElement).querySelector('.match-timeline-chevron') as HTMLElement | null;
          if (!timelineEl) return;

          const isExpanded = (btn as HTMLElement).getAttribute('aria-expanded') === 'true';
          (btn as HTMLElement).setAttribute('aria-expanded', isExpanded ? 'false' : 'true');
          timelineEl.classList.toggle('hidden', isExpanded);
          if (chevron) chevron.style.transform = isExpanded ? 'rotate(0deg)' : 'rotate(180deg)';
          if (isExpanded) return;

          if (timelineEl.getAttribute('data-loaded') === 'true') return;
          await loadMatchTimeline(matchId, timelineEl);
        });
      });

      matchesContent.querySelectorAll('.match-pin-toggle').forEach(btn => {
        btn.addEventListener('click', () => {
          const matchId = (btn as HTMLElement).getAttribute('data-match-id') || '';
          if (!matchId) return;
          togglePinnedMatch(matchId);
          renderMatches(currentMatches, currentGamertag);
        });
      });

      // Add event listeners for share buttons
      matchesContent.querySelectorAll('.match-share-toggle').forEach(btn => {
        btn.addEventListener('click', async () => {
          const matchId = (btn as HTMLElement).getAttribute('data-match-id') || '';
          const gamertag = (btn as HTMLElement).getAttribute('data-gamertag') || '';
          if (!matchId || !gamertag) return;

          await showShareModal(matchId, gamertag);
        });
      });
    }

    async function performSearch(gamertag: string) {
      if (!gamertag.trim()) return;

      globalError.classList.add('hidden');
      globalError.innerHTML = '';
      resultsContainer.classList.remove('hidden');

      document.getElementById('player-gamertag')!.textContent = gamertag;

      showSkeleton('overview');
      showSkeleton('ranked');
      showSkeleton('leaders');
      showSkeleton('matches');

      document.getElementById('overview-content')!.classList.add('hidden');
      document.getElementById('ranked-content')!.classList.add('hidden');
      document.getElementById('leaders-content')!.classList.add('hidden');
      document.getElementById('matches-content')!.classList.add('hidden');

      addRecentSearch(gamertag);

      const [statsResult, matchesResult, seasonResult] = await Promise.all([
        getPlayerStats(gamertag),
        getPlayerMatches(gamertag),
        CURRENT_SEASON ? getPlayerSeasonStats(gamertag, CURRENT_SEASON.id) : Promise.resolve({ ok: false, error: { type: 'unknown', message: 'No season configured.' } }),
      ]);

      const matchesList = matchesResult.ok ? (matchesResult.data.Results || []) : [];

      if (statsResult.ok) {
        renderOverview(statsResult.data);
        renderRankedStats(statsResult.data, seasonResult.ok ? seasonResult.data : undefined);
      } else {
        hideSkeleton('overview');
        hideSkeleton('ranked');
        hideSkeleton('leaders');
        showError(document.getElementById('overview-error')!, statsResult.error);
      }

      if (matchesResult.ok) {
        renderMatches(matchesList, gamertag);
        renderLeaderUsage(matchesList);
        if (pendingShareMatchId) {
          const targetMatchId = pendingShareMatchId;
          pendingShareMatchId = null;
          await showShareModal(targetMatchId, gamertag);
        }
      } else {
        hideSkeleton('matches');
        showError(document.getElementById('matches-error')!, matchesResult.error);
        hideSkeleton('leaders');
        showError(document.getElementById('leaders-error')!, matchesResult.error);
      }
    }

    searchBtn.addEventListener('click', () => performSearch(searchInput.value));
    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') performSearch(searchInput.value);
    });
    searchInput.addEventListener('focus', () => stopSearchPlaceholderRotation(true));
    searchInput.addEventListener('blur', () => startSearchPlaceholderRotation());
    searchInput.addEventListener('input', () => {
      if (searchInput.value.trim() !== '') {
        stopSearchPlaceholderRotation(false);
      } else if (document.activeElement !== searchInput) {
        startSearchPlaceholderRotation();
      }
    });

    startSearchPlaceholderRotation();

    renderRecentSearches();

    const urlParams = new URLSearchParams(window.location.search);
    const gamertagParam = urlParams.get('gamertag');
    const matchIdParam = urlParams.get('matchId');
    if (matchIdParam) {
      pendingShareMatchId = matchIdParam;
    }
    if (gamertagParam) {
      stopSearchPlaceholderRotation(false);
      searchInput.value = gamertagParam;
      performSearch(gamertagParam);
    }
  </script>
</BaseLayout>
