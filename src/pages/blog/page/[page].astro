---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import BlogCard from '../../../components/BlogCard/BlogCard.astro';
import Header from '../../../components/Header.astro';
import Footer from '../../../components/Footer.astro';
import SidePanel from '../../../components/SidePanel.astro';
import { Input, Select } from 'webcoreui/astro';
import blogPosts from '../../../data/blogPosts.js';
import '../../../styles/webcore.scss';
import '../../../styles/blog-overrides.scss';

export function getStaticPaths() {
  const pageSize = 12;
  const sortedPosts = [...blogPosts].sort((a, b) => {
    const aDate = a.dateIso ? Date.parse(a.dateIso) : 0;
    const bDate = b.dateIso ? Date.parse(b.dateIso) : 0;
    return bDate - aDate;
  });

  const totalPages = Math.ceil(sortedPosts.length / pageSize);

  return Array.from({ length: totalPages }, (_, index) => {
    const pageNumber = index + 1;
    const start = index * pageSize;
    const end = start + pageSize;
    return {
      params: { page: String(pageNumber) },
      props: {
        page: {
          data: sortedPosts.slice(start, end),
          currentPage: pageNumber,
          lastPage: totalPages
        }
      }
    };
  });
}

const sortedPosts = [...blogPosts].sort((a, b) => {
  const aDate = a.dateIso ? Date.parse(a.dateIso) : 0;
  const bDate = b.dateIso ? Date.parse(b.dateIso) : 0;
  return bDate - aDate;
});

const { page } = Astro.props;
const paginatedPosts = page.data;
const totalPages = page.lastPage;
const currentPage = page.currentPage;

// Get unique categories for filter
const categories = [...new Set(blogPosts.map(post => post.category))];
const categoryItems = [
  { name: 'All Categories', value: 'all' },
  ...categories.map(cat => ({ name: cat, value: cat }))
];

const tags = [
  ...new Set(
    blogPosts.reduce((acc, post) => {
      if (post.tags?.length) {
        acc.push(...post.tags);
      }
      return acc;
    }, [])
  )
];
const tagItems = [
  { name: 'All Tags', value: 'all' },
  ...tags.map(tag => ({ name: tag, value: tag }))
];

const sortItems = [
  { name: 'Newest', value: 'newest' },
  { name: 'Oldest', value: 'oldest' },
  { name: 'Title A-Z', value: 'title-asc' },
  { name: 'Title Z-A', value: 'title-desc' }
];
---
<BaseLayout
  title={`Team Respawn Blog - Page ${currentPage}`}
  description={`Gaming news, reviews, and insights from Team Respawn. Page ${currentPage}.`}
  canonical={`https://www.teamrespawntv.com/blog/page/${currentPage}`}
  ogTitle="Team Respawn Blog"
  ogDescription="Gaming news, reviews, and insights from Team Respawn."
  bodyClass="blog-page"
>
  <div class="container mx-auto p-4 sm:p-8">
    <Header />

    <main class="pt-8">
      <!-- Search and Filter Section -->
      <div class="blog-search-filter mb-8 bg-gray-800/50 border border-gray-700 rounded-lg p-4 sm:p-6">
        <div class="flex flex-col lg:flex-row gap-4">
          <div class="flex-1">
            <Input
              type="search"
              id="blog-search"
              placeholder="Search articles..."
              className="w-full"
            />
          </div>
          <div class="sm:w-48">
            <Select
              name="category-filter"
              placeholder="All Categories"
              itemGroups={[{ items: categoryItems }]}
            />
          </div>
          <div class="sm:w-48">
            <Select
              name="tag-filter"
              placeholder="All Tags"
              itemGroups={[{ items: tagItems }]}
            />
          </div>
          <div class="sm:w-40">
            <Select
              name="sort-filter"
              placeholder="Newest"
              itemGroups={[{ items: sortItems }]}
            />
          </div>
        </div>
        <div id="blog-active-filters" class="blog-active-filters hidden">
          <span class="blog-active-label">Active filters</span>
          <div id="blog-active-filter-list" class="blog-active-list" aria-live="polite"></div>
          <button id="blog-clear-filters" class="blog-active-clear" type="button">
            Clear
          </button>
        </div>
      </div>

      <!-- Latest Articles Section -->
      <h2 class="text-2xl font-bold text-white mb-8">Latest Articles</h2>

      <div id="blog-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {paginatedPosts.map((post, index) => (
          <div
            class="blog-card-wrapper"
            data-title={post.title.toLowerCase()}
            data-category={post.category}
            data-excerpt={post.excerpt.toLowerCase()}
            data-tags={(post.tags || []).join('|').toLowerCase()}
            data-date={post.dateIso}
          >
            <BlogCard
              href={post.href}
              img={post.img}
              title={post.title}
              text={`<span class="blog-category">${post.category}</span><br/>${post.excerpt}`}
            />
          </div>
        ))}
      </div>

      <!-- No results message -->
      <div id="no-results" class="hidden text-center py-12">
        <p class="text-xl text-gray-400">No articles found matching your criteria.</p>
      </div>

      {totalPages > 1 && (
        <nav class="mt-12 flex justify-center" aria-label="Blog pagination">
          <div class="inline-flex flex-wrap items-center gap-2">
            {currentPage > 1 && (
              <a
                href={currentPage === 2 ? '/blog' : `/blog/page/${currentPage - 1}`}
                class="px-3 py-2 rounded-lg bg-gray-800 text-gray-200 border border-gray-700 hover:bg-gray-700"
                aria-label="Previous page"
              >
                Previous
              </a>
            )}
            {Array.from({ length: totalPages }, (_, i) => {
              const pageNumber = i + 1;
              const href = pageNumber === 1 ? '/blog' : `/blog/page/${pageNumber}`;
              const isActive = pageNumber === currentPage;
              return (
                <a
                  href={href}
                  class={`px-3 py-2 rounded-lg border ${
                    isActive
                      ? 'bg-cyan-500 text-white border-cyan-400'
                      : 'bg-gray-800 text-gray-200 border-gray-700 hover:bg-gray-700'
                  }`}
                  aria-current={isActive ? 'page' : undefined}
                >
                  {pageNumber}
                </a>
              );
            })}
            {currentPage < totalPages && (
              <a
                href={`/blog/page/${currentPage + 1}`}
                class="px-3 py-2 rounded-lg bg-gray-800 text-gray-200 border border-gray-700 hover:bg-gray-700"
                aria-label="Next page"
              >
                Next
              </a>
            )}
          </div>
        </nav>
      )}
    </main>

    <Footer />
  </div>

  <SidePanel />

  <script src="/js/dropdowns.js" is:inline></script>
  <script src="/js/tabs.js" is:inline></script>
  <script src="/js/side-panel.js" is:inline></script>
  <script src="/js/secondary-init.js" is:inline></script>

  <!-- Blog post data for client-side filtering -->
  <script define:vars={{ blogPosts }}>
    window.blogPostsData = blogPosts;
  </script>
  <script src="/js/blog-search.js" is:inline></script>
</BaseLayout>
