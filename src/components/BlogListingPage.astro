---
import BaseLayout from '../layouts/BaseLayout.astro';
import BlogCard from './BlogCard.astro';
import BlogHeader from './BlogHeader.astro';
import Footer from './Footer.astro';
import Header from './Header.astro';
import SidePanel from './SidePanel.astro';
import { Pagination } from 'webcoreui/astro';
import '../styles/webcore.scss';

const {
  posts,
  paginationPages,
  previousLink,
  nextLink,
  disablePrevious = false,
  disableNext = false,
  showPagination = true,
  canonical = 'https://www.teamrespawntv.com/blog'
} = Astro.props;
---
<BaseLayout
  title="Team Respawn Blog | News, Reviews, and Insights"
  description="The Team Respawn blog covers gaming news, reviews, and deep dives across strategy, FPS, and indie hits."
  canonical={canonical}
  ogTitle="Team Respawn Blog"
  ogDescription="Gaming news, reviews, and insights from Team Respawn."
  bodyClass="blog-page"
>
  <div class="container mx-auto p-4 sm:p-8">
    <Header />
    <BlogHeader showFilters={true} />

    <div id="blog-filter-overlay" class="fixed inset-0 bg-black/60 opacity-0 pointer-events-none transition-opacity duration-300 lg:hidden"></div>

    <main class="grid grid-cols-1 lg:grid-cols-[260px,1fr] gap-8">
      <aside
        id="blog-filter-panel"
        class="fixed right-0 top-0 h-full w-72 bg-gray-900 border-l border-gray-800 p-6 shadow-2xl translate-x-full transition-transform duration-300 lg:static lg:h-auto lg:w-auto lg:rounded-xl lg:translate-x-0 lg:border lg:shadow-lg"
        aria-label="Blog filters"
      >
        <div class="flex items-center justify-between mb-6 lg:hidden">
          <h2 class="text-lg font-bold">Filters</h2>
          <button
            id="blog-filter-close"
            class="p-2 rounded-full hover:bg-gray-800 transition-colors duration-200"
            aria-label="Close filters"
            type="button"
          >
            <i class="fas fa-times text-gray-300" aria-hidden="true"></i>
          </button>
        </div>

        <div class="space-y-4">
          <label class="block text-sm font-semibold text-gray-200" for="blog-filter-search">Search</label>
          <input
            id="blog-filter-search"
            type="text"
            placeholder="Search titles..."
            class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-gray-100 focus:outline-none focus:ring-2 focus:ring-yellow-500"
          />
        </div>

        <div class="space-y-2 mt-6">
          <label class="block text-sm font-semibold text-gray-200" for="blog-filter-category">Category</label>
          <select
            id="blog-filter-category"
            class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-gray-100 focus:outline-none focus:ring-2 focus:ring-yellow-500"
          >
            <option value="all">All</option>
            <option value="Features">Features</option>
            <option value="Reviews">Reviews</option>
            <option value="Insights">Insights</option>
            <option value="Spotlight">Spotlight</option>
          </select>
        </div>

        <div class="space-y-2 mt-6">
          <label class="block text-sm font-semibold text-gray-200" for="blog-filter-sort">Sort by</label>
          <select
            id="blog-filter-sort"
            class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-gray-100 focus:outline-none focus:ring-2 focus:ring-yellow-500"
          >
            <option value="newest">Newest</option>
            <option value="oldest">Oldest</option>
            <option value="title-asc">Title A-Z</option>
            <option value="title-desc">Title Z-A</option>
          </select>
        </div>

        <button
          id="blog-filter-reset"
          class="mt-6 w-full bg-gray-800 hover:bg-gray-700 text-gray-100 font-semibold py-2 px-4 rounded-lg transition-colors duration-200"
          type="button"
        >
          Reset filters
        </button>
      </aside>

      <section>
        <div id="blog-posts-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {posts.map((post) => (
            <BlogCard {...post} />
          ))}
        </div>
        {showPagination && (
          <div class="mt-12 flex justify-center">
            <Pagination
              pages={paginationPages}
              showChevrons={true}
              showDots={true}
              disablePrevious={disablePrevious}
              disableNext={disableNext}
              previousLink={previousLink}
              nextLink={nextLink}
            />
          </div>
        )}
      </section>
    </main>
    <Footer />
  </div>

  <SidePanel />

  <script src="/js/dropdowns.js" is:inline></script>
  <script src="/js/tabs.js" is:inline></script>
  <script src="/js/side-panel.js" is:inline></script>
  <script src="/js/secondary-init.js" is:inline></script>
  <script is:inline>
    const filterToggle = document.getElementById('blog-filter-toggle');
    const filterClose = document.getElementById('blog-filter-close');
    const filterPanel = document.getElementById('blog-filter-panel');
    const filterOverlay = document.getElementById('blog-filter-overlay');
    const searchInput = document.getElementById('blog-filter-search');
    const categorySelect = document.getElementById('blog-filter-category');
    const sortSelect = document.getElementById('blog-filter-sort');
    const resetButton = document.getElementById('blog-filter-reset');
    const postsGrid = document.getElementById('blog-posts-grid');
    const postCards = postsGrid ? Array.from(postsGrid.querySelectorAll('[data-blog-post]')) : [];

    const openFilters = () => {
      if (!filterPanel || !filterOverlay || !filterToggle) return;
      filterPanel.classList.remove('translate-x-full');
      filterOverlay.classList.remove('opacity-0', 'pointer-events-none');
      filterToggle.setAttribute('aria-expanded', 'true');
    };

    const closeFilters = () => {
      if (!filterPanel || !filterOverlay || !filterToggle) return;
      filterPanel.classList.add('translate-x-full');
      filterOverlay.classList.add('opacity-0', 'pointer-events-none');
      filterToggle.setAttribute('aria-expanded', 'false');
    };

    const normalize = (value) => (value || '').toLowerCase();

    const applyFilters = () => {
      const searchValue = normalize(searchInput?.value);
      const categoryValue = categorySelect?.value || 'all';
      const sortValue = sortSelect?.value || 'newest';

      let filtered = postCards.filter((post) => {
        const title = normalize(post.dataset.title);
        const category = post.dataset.category || '';
        const matchesSearch = !searchValue || title.includes(searchValue);
        const matchesCategory = categoryValue === 'all' || category === categoryValue;
        return matchesSearch && matchesCategory;
      });

      filtered.sort((a, b) => {
        const titleA = normalize(a.dataset.title);
        const titleB = normalize(b.dataset.title);
        const dateA = a.dataset.date || '';
        const dateB = b.dataset.date || '';

        switch (sortValue) {
          case 'oldest':
            return dateA.localeCompare(dateB);
          case 'title-asc':
            return titleA.localeCompare(titleB);
          case 'title-desc':
            return titleB.localeCompare(titleA);
          default:
            return dateB.localeCompare(dateA);
        }
      });

      if (postsGrid) {
        postsGrid.innerHTML = '';
        filtered.forEach((post) => postsGrid.appendChild(post));
      }
    };

    const resetFilters = () => {
      if (searchInput) searchInput.value = '';
      if (categorySelect) categorySelect.value = 'all';
      if (sortSelect) sortSelect.value = 'newest';
      applyFilters();
    };

    if (filterToggle) filterToggle.addEventListener('click', openFilters);
    if (filterClose) filterClose.addEventListener('click', closeFilters);
    if (filterOverlay) filterOverlay.addEventListener('click', closeFilters);
    if (searchInput) searchInput.addEventListener('input', applyFilters);
    if (categorySelect) categorySelect.addEventListener('change', applyFilters);
    if (sortSelect) sortSelect.addEventListener('change', applyFilters);
    if (resetButton) resetButton.addEventListener('click', resetFilters);
  </script>
</BaseLayout>
